<!DOCTYPE html>
<html>
<head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    <div id="toast-container"></div>
    
    <%- include('partials/navbar') %>

    <main>
        <div style="margin-bottom: 20px;">
            <a href="/" style="text-decoration: none; color: #333; font-weight: bold;">
                &larr; Back to Dashboard
            </a>
        </div>
        
        <h1>Edit Profile for <%= user.name %></h1>

        <form id="profileForm">
            <h2>Personal Information</h2>
            
            <label for="avatarStyle">Avatar Style:</label>
            <select id="avatarStyle">
                <option value="bottts" <%= user.avatarStyle === 'bottts' ? 'selected' : '' %>>ðŸ¤– Robots</option>
                <option value="avataaars" <%= user.avatarStyle === 'avataaars' ? 'selected' : '' %>>ðŸ§‘ Humans</option>
                <option value="identicon" <%= user.avatarStyle === 'identicon' ? 'selected' : '' %>>ðŸ”· Shapes</option>
                <option value="initials" <%= user.avatarStyle === 'initials' ? 'selected' : '' %>>ðŸ”  Initials</option>
                <option value="micah" <%= user.avatarStyle === 'micah' ? 'selected' : '' %>>ðŸŽ¨ Hand Drawn</option>
            </select>

            <label for="userName">Full Name:</label>
            <input type="text" id="userName" value="<%= user.name %>" required>

            <label for="gradeLevel">Grade Level:</label>
            <input type="text" id="gradeLevel" value="<%= user.gradeLevel || '' %>">

            <button type="submit">Update Profile</button>
        </form>

        <hr>

        <form id="skillOfferForm">
            <h2>Skills You Offer</h2>
            <p>Check the skills you want to teach, and select where you can teach them.</p>

            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Offer?</th>
                            <th style="text-align: left;">Skill Name</th>
                            <th style="text-align: center;">I can teach<br>Virtual</th>
                            <th style="text-align: center;">I can teach<br>In-Person</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% masterSkills.forEach(skill => { %>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td>
                                    <input type="checkbox" 
                                        class="skill-toggle" 
                                        data-id="<%= skill.skill_id %>"
                                        id="skill_<%= skill.skill_id %>">
                                </td>
                                
                                <td>
                                    <label for="skill_<%= skill.skill_id %>"><%= skill.skill_name %></label>
                                </td>

                                <td style="text-align: center;">
                                    <input type="checkbox" 
                                        class="loc-virtual" 
                                        data-id="<%= skill.skill_id %>">
                                </td>
                                <td style="text-align: center;">
                                    <input type="checkbox" 
                                        class="loc-inperson" 
                                        data-id="<%= skill.skill_id %>">
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
            
            <p style="font-size: 0.9em; color: #666;">
                * If you check both Virtual and In-Person, you will appear in searches for both.
            </p>

            <button type="submit" style="margin-top: 15px;">Save Offered Skills</button>
        </form>

        <hr>

        <form id="skillSeekForm">
            <h2>Skills You Want to Learn</h2>
            <p>Check the skills you want to learn, and select your preferred setting.</p>

            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Seek?</th>
                            <th style="text-align: left;">Skill Name</th>
                            <th style="text-align: center;">Prefer<br>Virtual</th>
                            <th style="text-align: center;">Prefer<br>In-Person</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% masterSkills.forEach(skill => { %>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td>
                                    <input type="checkbox" 
                                        class="seek-toggle" 
                                        data-id="<%= skill.skill_id %>"
                                        id="seek_skill_<%= skill.skill_id %>">
                                </td>
                                
                                <td>
                                    <label for="seek_skill_<%= skill.skill_id %>"><%= skill.skill_name %></label>
                                </td>

                                <td style="text-align: center;">
                                    <input type="checkbox" 
                                        class="seek-virtual" 
                                        data-id="<%= skill.skill_id %>">
                                </td>
                                <td style="text-align: center;">
                                    <input type="checkbox" 
                                        class="seek-inperson" 
                                        data-id="<%= skill.skill_id %>">
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
            
            <button type="submit" style="margin-top: 15px;">Save Sought Skills</button>
        </form>

        <hr>
        
        <h2>Missing a Skill?</h2>
        <form id="suggestSkillForm">
            <input type="text" id="newSkillName" placeholder="e.g., Quantum Physics Tutoring">
            <button type="submit">Suggest Skill</button>
        </form>
        
    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // --- Client-Side JavaScript Logic ---
        
        const userId = '<%= user.id %>'; // pass the user's id for api submissions

        // helper function to show toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 1. logic for saving skills offered
        document.getElementById('skillOfferForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const skillsToSubmit = [];
            
            // iterate over all the master checkboxes to find selected skills
            const skillCheckboxes = document.querySelectorAll('.skill-toggle');

            skillCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const id = checkbox.getAttribute('data-id');
                    
                    // find the corresponding location checkboxes for this skill id
                    const canDoVirtual = document.querySelector(`.loc-virtual[data-id="${id}"]`).checked;
                    const canDoInPerson = document.querySelector(`.loc-inperson[data-id="${id}"]`).checked;

                    // translation logic converts ui choices to database flags
                    let isVirtualOnly = false;
                    let isInPersonOnly = false;

                    if (canDoVirtual && !canDoInPerson) {
                        isVirtualOnly = true;
                    } else if (!canDoVirtual && canDoInPerson) {
                        isInPersonOnly = true;
                    } 
                    // if both are checked, both flags remain false meaning flexible

                    skillsToSubmit.push({
                        skillId: id,
                        isVirtualOnly: isVirtualOnly,
                        isInPersonOnly: isInPersonOnly
                    });
                }
            });

            try {
                // sends the array of selected skills to the backend
                const response = await axios.post('/api/user/skills/offer', {
                    userId: userId, 
                    skills: skillsToSubmit
                });
                showToast(response.data.message, "success");
            } catch (error) {
                showToast('Failed to save skills. Please try again.', "error");
                console.error(error);
            }
        });

        // 2. logic for saving skills sought
        document.getElementById('skillSeekForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const skillsToSubmit = [];
            
            // iterate over the seek toggle checkboxes
            const skillCheckboxes = document.querySelectorAll('.seek-toggle');

            skillCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const id = checkbox.getAttribute('data-id');
                    
                    const wantVirtual = document.querySelector(`.seek-virtual[data-id="${id}"]`).checked;
                    const wantInPerson = document.querySelector(`.seek-inperson[data-id="${id}"]`).checked;

                    let isVirtualOnly = false;
                    let isInPersonOnly = false;

                    if (wantVirtual && !wantInPerson) {
                        isVirtualOnly = true;
                    } else if (!wantVirtual && wantInPerson) {
                        isInPersonOnly = true;
                    } 

                    skillsToSubmit.push({
                        skillId: id,
                        isVirtualOnly: isVirtualOnly,
                        isInPersonOnly: isInPersonOnly
                    });
                }
            });

            try {
                const response = await axios.post('/api/user/skills/seek', {
                    userId: userId, 
                    skills: skillsToSubmit
                });
                showToast(response.data.message, "success");
            } catch (error) {
                showToast('Failed to save sought skills.', "error");
                console.error(error);
            }
        });
        
        // 3. logic for suggesting a skill
        document.getElementById('suggestSkillForm').addEventListener('submit', async (e) => {
             e.preventDefault();
             const skillName = document.getElementById('newSkillName').value;

             if (!skillName) return;

             try {
                const response = await axios.post('/api/skills/suggest', {
                    skillName: skillName,
                    userId: userId 
                });
                showToast(response.data.message, "success");
                document.getElementById('newSkillName').value = '';
            } catch (error) {
                const msg = error.response?.data?.message || 'Error suggesting skill.';
                showToast(msg, "error");
            }
        });

        // 4. logic for basic profile update
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userName = document.getElementById('userName').value;
            const gradeLevel = document.getElementById('gradeLevel').value;
            const avatarStyle = document.getElementById('avatarStyle').value;

            try {
                const response = await axios.put(`/api/user/profile/${userId}`, {
                    userName: userName,
                    gradeLevel: gradeLevel,
                    avatarStyle: avatarStyle
                });
                showToast(response.data.message, "success");
            } catch (error) {
                const msg = error.response?.data?.message || 'Failed to update profile.';
                showToast(msg, "error");
            }
        });

       // 5. pre-fill skills on page load
       // fetches the users current skills and checks the boxes
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await axios.get(`/api/user/skills/${userId}`);
                const { offered, sought } = response.data;

                const checkBoxes = (skillList, type) => {
                    skillList.forEach(skill => {
                        const id = skill.skill_id;
                        
                        // check the master toggle for this skill
                        const masterBox = document.getElementById(`${type}skill_${id}`);
                        if (masterBox) masterBox.checked = true;

                        const virtualClass = type === 'seek_' ? '.seek-virtual' : '.loc-virtual';
                        const inPersonClass = type === 'seek_' ? '.seek-inperson' : '.loc-inperson';

                        const virtualBox = document.querySelector(`${virtualClass}[data-id="${id}"]`);
                        const inPersonBox = document.querySelector(`${inPersonClass}[data-id="${id}"]`);

                        // determine which location boxes to check based on db flags
                        if (skill.is_virtual_only) {
                            if (virtualBox) virtualBox.checked = true;
                        } else if (skill.is_inperson_only) {
                            if (inPersonBox) inPersonBox.checked = true;
                        } else {
                            // if neither is restricted check both
                            if (virtualBox) virtualBox.checked = true;
                            if (inPersonBox) inPersonBox.checked = true;
                        }
                    });
                };

                if (offered.length > 0) checkBoxes(offered, '');
                if (sought.length > 0) checkBoxes(sought, 'seek_');

            } catch (error) {
                console.error('Failed to load existing skills:', error);
            }
        });
    </script>
</body>
</html>