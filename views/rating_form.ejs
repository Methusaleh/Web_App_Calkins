<!DOCTYPE html>
<html>
<head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css">
    <style>
        .rating-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .radio-group {
            margin: 20px 0;
            padding: 10px;
            background: white;
            border: 1px solid #eee;
        }
        .radio-option {
            margin-right: 20px;
            font-size: 1.1em;
            cursor: pointer;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <main>
        <div style="margin-bottom: 20px;">
            <a href="/my_sessions" style="text-decoration: none; color: #333; font-weight: bold;">&larr; Back to My Sessions</a>
        </div>

        <div class="rating-container">
            <h1>Rate Your Session</h1>
            <p>How was your session with <strong><%= session.provider_name %></strong>?</p>
            
            <form id="ratingForm">
                <input type="hidden" id="sessionId" value="<%= session.session_id %>">
                <input type="hidden" id="raterId" value="<%= user.id %>">
                <input type="hidden" id="rateeId" value="<%= session.provider_id %>">

                <label><strong>Would you recommend this teacher?</strong></label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="likeStatus" value="true" required> 
                        üëç Yes (Like)
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="likeStatus" value="false"> 
                        üëé No
                    </label>
                </div>

                <label for="feedbackText"><strong>Additional Comments (Optional):</strong></label>
                <textarea id="feedbackText" placeholder="What did you learn? How was the teaching style?"></textarea>

                <button type="submit" style="margin-top: 15px;">Submit Rating</button>
            </form>

            <p id="messageArea" style="margin-top: 15px; font-weight: bold;"></p>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        document.getElementById('ratingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const messageArea = document.getElementById('messageArea');
            
            // Get Values
            const sessionId = document.getElementById('sessionId').value;
            const raterId = document.getElementById('raterId').value;
            const rateeId = document.getElementById('rateeId').value;
            const feedbackText = document.getElementById('feedbackText').value;
            
            // Get the selected Radio Button value
            const likeRadio = document.querySelector('input[name="likeStatus"]:checked');
            const likeStatus = likeRadio ? (likeRadio.value === 'true') : null;

            if (likeStatus === null) {
                messageArea.textContent = "Please select whether you recommend this teacher.";
                messageArea.style.color = "red";
                return;
            }

            try {
                const response = await axios.post('/api/sessions/rate', {
                    sessionId: sessionId,
                    raterId: raterId,
                    rateeId: rateeId,
                    likeStatus: likeStatus,
                    feedbackText: feedbackText
                });

                messageArea.textContent = "Rating submitted successfully! Redirecting...";
                messageArea.style.color = "green";

                // Redirect back to session list after 1.5 seconds
                setTimeout(() => {
                    window.location.href = '/my_sessions';
                }, 1500);

            } catch (error) {
                console.error(error);
                const msg = error.response?.data?.message || 'Error submitting rating.';
                messageArea.textContent = msg;
                messageArea.style.color = "red";
            }
        });
    </script>
</body>
</html>