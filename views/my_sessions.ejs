<!DOCTYPE html>
<html>
  <head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <style>
      /* table styles */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
      }
      th {
        background-color: #f4f4f4;
      }

      /* status colors */
      .status-requested {
        color: #d97706;
        font-weight: bold;
      }
      .status-confirmed {
        color: #059669;
        font-weight: bold;
      }
      .status-denied,
      .status-cancelled {
        color: #dc2626;
      }
      .status-completed {
        color: #2563eb;
      }

      /* button styles */
      .btn-action {
        padding: 5px 10px;
        font-size: 0.9em;
        margin-right: 5px;
        cursor: pointer;
        border-radius: 4px;
        border: none;
        color: white;
        background-color: var(--primary-color);
      }
      .btn-danger {
        background-color: #ef4444;
      }
    </style>
  </head>
  <body>
    <div id="toast-container"></div>
    <%- include('partials/navbar') %>

    <main>
      <div style="margin-bottom: 20px">
        <a
          href="/"
          style="text-decoration: none; color: #333; font-weight: bold"
          >&larr; Back to Dashboard</a
        >
      </div>

      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <h1 style="margin: 0; flex-grow: 1">My Sessions</h1>
        <a
          href="/session/request"
          class="btn-primary"
          style="padding: 10px 15px; border-radius: 5px; font-weight: bold"
        >
          + New Request
        </a>
      </div>

      <p id="loadingMsg">Loading your session history...</p>

      <table id="sessionsTable" style="display: none">
        <thead>
          <tr>
            <th>Date/Time</th>
            <th>Role</th>
            <th>With</th>
            <th>Topic</th>
            <th>Status</th>
            <th>Actions / Link</th>
          </tr>
        </thead>
        <tbody id="sessionsBody"></tbody>
      </table>
    </main>
    <%- include('partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      // prevent double clicks
      window.isProcessing = false;

      // show toast notification
      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");

        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;

        container.appendChild(toast);

        requestAnimationFrame(() => {
          toast.classList.add("show");
        });

        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 3000);
      }

      // get current user id
      const currentUserId = "<%= user.id %>";

      // load sessions on start
      document.addEventListener("DOMContentLoaded", fetchSessions);

      async function fetchSessions() {
        try {
          // fetch session history
          const response = await axios.get(
            `/api/sessions/user/${currentUserId}`
          );
          const sessions = response.data.sessions;

          const tbody = document.getElementById("sessionsBody");
          tbody.innerHTML = "";

          // handle empty state
          if (sessions.length === 0) {
            document.getElementById("loadingMsg").innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px;">
                            <h3>You haven't scheduled any sessions yet!</h3>
                            <p style="color: #666; margin-bottom: 20px;">Find a tutor or offer your skills to get started.</p>
                            <a href="/session/request" class="btn-primary" style="padding: 10px 20px; border-radius: 5px;">Find a Tutor</a>
                            <span style="margin: 0 10px;">or</span>
                            <a href="/profile/edit" style="color: #ea5455cc;">Update Profile</a>
                        </div>
                    `;
            return;
          }

          // create table rows
          sessions.forEach((session) => {
            const row = document.createElement("tr");

            // check user role
            const isTeacher =
              String(currentUserId) === String(session.provider_id);
            const myRole = isTeacher ? "Teacher" : "Student";
            const otherPersonName = isTeacher
              ? session.requester_name
              : session.provider_name;
            const otherPersonId = isTeacher
              ? session.requester_id
              : session.provider_id;

            // format date
            const dateObj = new Date(session.session_date_time);
            const dateStr = dateObj.toLocaleString();

            let actionsHtml = "";

            // generate action buttons based on status
            if (session.status === "Requested") {
              if (isTeacher) {
                // teacher options
                actionsHtml = `
                                <button class="btn-action" onclick="confirmSession(${session.session_id}, '${session.location_type}')">Confirm</button>
                                <button class="btn-action btn-danger" onclick="denySession(${session.session_id})">Deny</button>
                            `;
              } else {
                // student options
                actionsHtml = `<button class="btn-action btn-danger" onclick="denySession(${session.session_id})">Cancel Request</button>`;
              }
            } else if (session.status === "Confirmed") {
              // show meet link
              if (session.location_type === "Online" && session.meeting_url) {
                actionsHtml += `<a href="${session.meeting_url}" target="_blank" style="font-weight:bold;">üé• Join Meeting</a><br><br>`;
              } else if (session.location_type === "In-Person") {
                actionsHtml += `<span>üìç In-Person</span><br><br>`;
              }

              if (isTeacher) {
                actionsHtml += `<button class="btn-action" onclick="completeSession(${session.session_id})">Mark Complete</button>`;
              } else {
                actionsHtml += `<span style="font-size:0.8em; color:gray;">Waiting for teacher to complete</span>`;
              }
            } else if (session.status === "Completed") {
              if (!isTeacher) {
                if (session.is_rated) {
                  actionsHtml =
                    '<span style="color:#059669; font-weight:bold;">‚úì Rated</span>';
                } else {
                  actionsHtml = `<a href="/session/rate/${session.session_id}" class="btn-action">Rate Teacher</a>`;
                }
              } else {
                actionsHtml = "<span>‚úÖ Complete</span>";
              }
            } else {
              actionsHtml = "<span>---</span>";
            }

            row.innerHTML = `
                        <td>${dateStr}</td>
                        <td>${myRole}</td>
                        <td>
                            <a href="/profile/view/${otherPersonId}" style="font-weight: bold; color: var(--primary-color);">
                                ${otherPersonName}
                            </a>
                        </td>
                        <td>${session.skill_name}</td>
                        <td class="status-${session.status.toLowerCase()}">${
              session.status
            }</td>
                        <td>${actionsHtml}</td>
                    `;
            tbody.appendChild(row);
          });

          document.getElementById("loadingMsg").style.display = "none";
          document.getElementById("sessionsTable").style.display = "table";
        } catch (error) {
          console.error(error);
          document.getElementById("loadingMsg").textContent =
            "Error loading session history.";
        }
      }

      // confirm session
      async function confirmSession(id, locationType) {
        // check lock
        if (window.isProcessing) return;
        window.isProcessing = true;

        let meetUrl = null;

        // handle meeting url
        if (locationType === "Online") {
          meetUrl = prompt(
            "Please enter the Video Call Link (e.g., Zoom, Google Meet) for this session:"
          );

          if (meetUrl === null) {
            window.isProcessing = false;
            return;
          }
        }

        try {
          await axios.post("/api/sessions/confirm", {
            sessionId: id,
            meetingUrl: meetUrl,
          });

          showToast("Session Confirmed!", "success");
          fetchSessions();
        } catch (err) {
          const msg = err.response?.data?.message || "Error confirming session";
          showToast(msg, "error");
        } finally {
          window.isProcessing = false;
        }
      }

      // deny or cancel session
      async function denySession(id) {
        if (window.isProcessing) return;
        window.isProcessing = true;

        if (!confirm("Are you sure you want to cancel/deny this session?")) {
          window.isProcessing = false;
          return;
        }

        try {
          await axios.post("/api/sessions/deny", {
            sessionId: id,
            reason: "User action",
          });

          showToast("Session cancelled successfully.", "success");
          fetchSessions();
        } catch (err) {
          const msg = err.response?.data?.message || "Error processing request";
          showToast(msg, "error");
        } finally {
          window.isProcessing = false;
        }
      }

      // complete session
      async function completeSession(id) {
        if (window.isProcessing) return;
        window.isProcessing = true;

        if (!confirm("Mark this session as fully completed?")) {
          window.isProcessing = false;
          return;
        }

        try {
          await axios.post("/api/sessions/complete", { sessionId: id });

          showToast("Session marked as complete!", "success");
          fetchSessions();
        } catch (err) {
          const msg = err.response?.data?.message || "Error completing session";
          showToast(msg, "error");
        } finally {
          window.isProcessing = false;
        }
      }
    </script>
  </body>
</html>