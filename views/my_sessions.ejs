<!DOCTYPE html>
<html>
<head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css">
    <style>
        /* Simple table styling for the dashboard */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f4f4f4; }
        
        /* Status Colors */
        .status-requested { color: #d97706; font-weight: bold; } /* Amber */
        .status-confirmed { color: #059669; font-weight: bold; } /* Green */
        .status-denied, .status-cancelled { color: #dc2626; }    /* Red */
        .status-completed { color: #2563eb; }                    /* Blue */

        .btn-action { padding: 5px 10px; font-size: 0.9em; margin-right: 5px; cursor: pointer; }
        .btn-danger { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <main>
        <div style="margin-bottom: 20px;">
            <a href="/" style="text-decoration: none; color: #333; font-weight: bold;">&larr; Back to Dashboard</a>
        </div>

        <h1>My Sessions</h1>
        <p id="loadingMsg">Loading your session history...</p>
        
        <table id="sessionsTable" style="display:none;">
            <thead>
                <tr>
                    <th>Date/Time</th>
                    <th>Role</th>
                    <th>With</th>
                    <th>Topic</th>
                    <th>Status</th>
                    <th>Actions / Link</th>
                </tr>
            </thead>
            <tbody id="sessionsBody">
                </tbody>
        </table>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        window.isProcessing = false;

        // --- Toast Notification Helper ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            
            // 1. Create the toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;

            // 2. Add to DOM
            container.appendChild(toast);

            // 3. Trigger Animation (needs a tiny delay to allow DOM render)
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // 4. Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                // Wait for fade out transition to finish before removing from DOM
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Current User ID from server session
        const currentUserId = '<%= user.id %>'; 

        document.addEventListener('DOMContentLoaded', fetchSessions);

        async function fetchSessions() {
            try {
                const response = await axios.get(`/api/sessions/user/${currentUserId}`);
                const sessions = response.data.sessions;
                
                const tbody = document.getElementById('sessionsBody');
                tbody.innerHTML = ''; 

                if (sessions.length === 0) {
                    // Inject HTML with a helpful message and link
                    document.getElementById('loadingMsg').innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px;">
                            <h3>You haven't scheduled any sessions yet!</h3>
                            <p style="color: #666; margin-bottom: 20px;">Find a tutor or offer your skills to get started.</p>
                            <a href="/session/request" style="background: #2563eb; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">Find a Tutor</a>
                            <span style="margin: 0 10px;">or</span>
                            <a href="/profile/edit" style="color: #2563eb;">Update Profile</a>
                        </div>
                    `;
                    return;
                }

                sessions.forEach(session => {
                    const row = document.createElement('tr');
                    
                    // 1. Determine Role (Teacher vs Student)
                    // We compare currentUserId (int) with session.provider_id (int)
                    const isTeacher = (String(currentUserId) === String(session.provider_id));
                    const myRole = isTeacher ? 'Teacher' : 'Student';
                    const otherPersonName = isTeacher ? session.requester_name : session.provider_name;

                    // 2. Format Date
                    const dateObj = new Date(session.session_date_time);
                    const dateStr = dateObj.toLocaleString(); // e.g., "11/14/2025, 2:30 PM"

                    // 3. Generate Action Buttons Logic
                    let actionsHtml = '';
                    
                    // --- REQUESTED STATE ---
                    if (session.status === 'Requested') {
                        if (isTeacher) {
                            // Teacher can Confirm or Deny
                            actionsHtml = `
                                <button class="btn-action" onclick="confirmSession(${session.session_id}, '${session.location_type}')">Confirm</button>
                                <button class="btn-action btn-danger" onclick="denySession(${session.session_id})">Deny</button>
                            `;
                        } else {
                            // Student can Cancel
                            actionsHtml = `<button class="btn-action btn-danger" onclick="denySession(${session.session_id})">Cancel Request</button>`;
                        }
                    } 
                    // --- CONFIRMED STATE ---
                    else if (session.status === 'Confirmed') {
                        // Show Meet Link if Online
                        if (session.location_type === 'Online' && session.meeting_url) {
                            actionsHtml += `<a href="${session.meeting_url}" target="_blank" style="font-weight:bold;">üé• Join Meeting</a><br><br>`;
                        } else if (session.location_type === 'In-Person') {
                            actionsHtml += `<span>üìç In-Person</span><br><br>`;
                        }

                        if (isTeacher) {
                            // Teacher can mark complete
                            actionsHtml += `<button class="btn-action" onclick="completeSession(${session.session_id})">Mark Complete</button>`;
                        } else {
                            // Student just waits
                            actionsHtml += `<span style="font-size:0.8em; color:gray;">Waiting for teacher to complete</span>`;
                        }
                    } 
                    // --- COMPLETED STATE ---
                    else if (session.status === 'Completed') {
                         if (!isTeacher) {
                             // Student can Rate (We will build the rating page next)
                             actionsHtml = `<a href="/session/rate/${session.session_id}" class="btn-action">Rate Teacher</a>`;
                         } else {
                             actionsHtml = '<span>‚úÖ Complete</span>';
                         }
                    } 
                    // --- DENIED/CANCELLED ---
                    else {
                        actionsHtml = '<span>---</span>';
                    }

                    row.innerHTML = `
                        <td>${dateStr}</td>
                        <td>${myRole}</td>
                        <td>${otherPersonName}</td>
                        <td>${session.skill_name}</td>
                        <td class="status-${session.status.toLowerCase()}">${session.status}</td>
                        <td>${actionsHtml}</td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('loadingMsg').style.display = 'none';
                document.getElementById('sessionsTable').style.display = 'table';

            } catch (error) {
                console.error(error);
                document.getElementById('loadingMsg').textContent = "Error loading session history.";
            }
        }

        // Global flag to prevent double clicks (Initialize this at top of script)
        window.isProcessing = false; 

        async function confirmSession(id, locationType) {
            // 1. CHECK LOCK: If already busy, stop immediately.
            if (window.isProcessing) return; 
            
            // 2. SET LOCK: Claim processing rights
            window.isProcessing = true;

            let meetUrl = null;

            // 3. Handle URL Prompt (Specific Logic)
            if (locationType === 'Online') {
                meetUrl = prompt("Please enter the Google Meet URL for this session:");
                
                if (meetUrl === null) {
                    // Important: If they hit Cancel, we must UNLOCK before returning!
                    window.isProcessing = false; 
                    return; 
                }
            }

            try {
                await axios.post('/api/sessions/confirm', {
                    sessionId: id,
                    meetingUrl: meetUrl
                });
                
                showToast("Session Confirmed!", "success");
                fetchSessions(); 

            } catch (err) { 
                const msg = err.response?.data?.message || 'Error confirming session';
                showToast(msg, "error"); 
                
            } finally {
                // 4. RELEASE LOCK: Always unlock, success or failure
                window.isProcessing = false;
            }
        }

        async function denySession(id) {
            // 1. CHECK LOCK
            if (window.isProcessing) return;
            window.isProcessing = true;

            // 2. CONFIRMATION CHECK
            // If they click "Cancel", we must UNLOCK before stopping.
            if(!confirm("Are you sure you want to cancel/deny this session?")) {
                window.isProcessing = false; // <--- Critical unlock
                return;
            }

            try {
                await axios.post('/api/sessions/deny', { sessionId: id, reason: 'User action' });
                
                showToast("Session cancelled successfully.", "success");
                fetchSessions();
            } catch (err) { 
                const msg = err.response?.data?.message || 'Error processing request';
                showToast(msg, "error");
            } finally {
                // 3. RELEASE LOCK (Runs on success OR error)
                window.isProcessing = false;
            }
        }

        async function completeSession(id) {
            // 1. CHECK LOCK
            if (window.isProcessing) return;
            window.isProcessing = true;

            // 2. CONFIRMATION CHECK
            if(!confirm("Mark this session as fully completed?")) {
                 window.isProcessing = false; // <--- Critical unlock
                 return;
            }
            
            try {
                await axios.post('/api/sessions/complete', { sessionId: id });
                
                showToast("Session marked as complete!", "success");
                fetchSessions();
            } catch (err) { 
                const msg = err.response?.data?.message || 'Error completing session';
                showToast(msg, "error"); 
            } finally {
                // 3. RELEASE LOCK
                window.isProcessing = false;
            }
        }
    </script>
</body>
</html>