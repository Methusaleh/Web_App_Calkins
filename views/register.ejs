<!DOCTYPE html>
<html>
<head>
    <title>SkillSwap - Register</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    <div id="toast-container"></div>

    <%- include('partials/navbar') %>

    <main>
        <h1>Create Your SkillSwap Account</h1>

        <form id="registerForm">
            <label for="email">Email *</label>
            <input type="email" id="regEmail" required>

            <label for="password">Password *</label>
            <input type="password" id="regPassword" required>

            <label for="passwordConfirm">Confirm Password *</label>
            <input type="password" id="passwordConfirm" required>

            <label for="userName">Full Name *</label>
            <input type="text" id="regUserName" required>

            <label for="dateOfBirth">Date of Birth *</label>
            <input type="date" id="regDateOfBirth" required>

            <label for="gradeLevel">Grade/Education Level</label>
            <select id="regGradeLevel">
                <option value="">-- Select --</option>
                <option value="6th">6th Grade</option>
                <option value="7th">7th Grade</option>
                <option value="8th">8th Grade</option>
                <option value="9th">9th Grade</option>
                <option value="10th">10th Grade</option>
                <option value="11th">11th Grade</option>
                <option value="12th">12th Grade</option>
                <option value="College">College</option>
            </select>

            <label for="schoolCollege">School/College</label>
            <input type="text" id="regSchoolCollege">

            <label for="avatarStyle">Choose Avatar Style:</label>
            <select id="regAvatarStyle">
                <option value="bottts">ðŸ¤– Robots (Default)</option>
                <option value="avataaars">ðŸ§‘ Humans</option>
                <option value="identicon">ðŸ”· Geometric Shapes</option>
                <option value="initials">ðŸ”  Initials</option>
                <option value="micah">ðŸŽ¨ Hand Drawn</option>
            </select>
            <p style="text-color: black; font-weight: bold;">* = Required field</p>

            <button type="submit">Register Account</button>
        </form>
        
        <p id="messageArea" style="margin-top: 15px;"></p>
    </main>

    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // helper function to show toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            // triggers the slide in animation
            requestAnimationFrame(() => toast.classList.add('show'));
            
            // removes the toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // listens for the form submit event
        document.getElementById('registerForm').addEventListener('submit', handleRegisterSubmit);

        // handles the registration logic
        async function handleRegisterSubmit(event) {
            // prevents the default form submission to stop page reload
            event.preventDefault(); 

            // get values from the form inputs
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('passwordConfirm').value;
            const userName = document.getElementById('regUserName').value;
            const dateOfBirth = document.getElementById('regDateOfBirth').value;
            const gradeLevel = document.getElementById('regGradeLevel').value;
            const schoolCollege = document.getElementById('regSchoolCollege').value;
            const avatarStyle = document.getElementById('regAvatarStyle').value;
            const messageArea = document.getElementById('messageArea');
            messageArea.textContent = ''; 

            // client side check to ensure passwords match
            if (password !== passwordConfirm) {
                showToast('Error: Passwords do not match.', 'error');
                return;
            }

            try {
                // sends the registration data to the backend api
                const response = await axios.post('/api/register', {
                    email: email,
                    password: password,
                    userName: userName,
                    dateOfBirth: dateOfBirth,
                    gradeLevel: gradeLevel, 
                    schoolCollege: schoolCollege,
                    avatarStyle: avatarStyle
                });

                // if registration is successful redirect to the login page
                if (response.status === 201) {
                    showToast('Registration successful! Redirecting to login...', 'success');
                    
                    // wait a moment for the toast to show before redirecting
                    setTimeout(() => {
                        window.location.href = '/'; 
                    }, 1500);
                }

            } catch (error) {
                // handle errors like duplicate email
                let errorMessage = 'An unexpected server error occurred.';
                
                if (error.response) {
                    errorMessage = error.response.data.message || errorMessage;
                }
                
                showToast(errorMessage, 'error');
                console.error('Registration Failed:', errorMessage);
            }
        }
    </script>
</body>
</html>
