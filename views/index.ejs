<!DOCTYPE html>
<html>
<head>
    <title>SkillSwap - <%= user ? 'Dashboard' : 'Login' %></title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    
    <main>
        
        <% if (user) { %>
        
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <img src="https://api.dicebear.com/7.x/<%= user.avatarStyle %>/svg?seed=<%= user.name %>" 
                     alt="Avatar" 
                     style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #2563eb;">
                
                <div>
                    <h1 style="margin: 0;">Welcome, <%= user.name %>!</h1>
                    <span style="color: #666; font-size: 0.9em;">
                        <%= user.isAdmin ? 'üõ°Ô∏è Administrator' : 'üéì Student' %>
                    </span>
                </div>
            </div>
            <p>You are logged in as a <%= user.isAdmin ? 'Platform Administrator' : 'Student User' %>.</p>

            <hr>
            <div style="margin-bottom: 30px; position: relative;">
                <h3>üîç Find Tutors & Students</h3>
                <input type="text" id="searchInput" placeholder="Search by Name (e.g. 'Test User') or Skill (e.g. 'Math')..." 
                       style="width: 100%; padding: 12px; font-size: 1em; border: 2px solid #ddd; border-radius: 6px;">
                
                <div id="searchResults" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; max-height: 300px; overflow-y: auto;">
                    </div>
            </div>

            <h2>Quick Links</h2>

            <div class="dashboard-actions" style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; flex: 1; min-width: 200px;">
                    <h3>üë§ Your Profile</h3>
                    <p>Keep your skills and details up to date.</p>
                    
                    <a href="/profile/edit" style="display:inline-block; margin-top:10px; font-weight:bold;">Edit Profile &rarr;</a>
                    
                    <br>
                    <a href="/profile/view/<%= user.id %>" style="display:inline-block; margin-top:10px; color: #555; font-size: 0.9em; text-decoration: none;">
                        üëÅÔ∏è View Public Profile
                    </a>
                </div>

                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; flex: 1; min-width: 200px;">
                    <h3>üìÖ Your Sessions</h3>
                    <p>View upcoming lessons or check requests.</p>
                    <a href="/my_sessions" style="display:inline-block; margin-top:10px; font-weight:bold;">Manage Sessions &rarr;</a>
                </div>

                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; flex: 1; min-width: 200px;">
                    <h3>üí¨ My Messages</h3>
                    <p>Chat with your tutors and students.</p>
                    <a href="/messages" style="display:inline-block; margin-top:10px; font-weight:bold;">Open Inbox &rarr;</a>
                </div>

                <% if (user.isAdmin) { %>
                    <div style="border: 1px solid #fca5a5; background: #fef2f2; padding: 15px; border-radius: 8px; flex: 1; min-width: 200px;">
                        <h3 style="color:#991b1b;">üõ°Ô∏è Admin Panel</h3>
                        <p>Manage users and security reports.</p>
                        <a href="/admin" style="display:inline-block; margin-top:10px; font-weight:bold; color:#991b1b;">Open Controls &rarr;</a>
                    </div>
                <% } %>
            </div>
            
            <br>
            <button id="logoutButton">Log Out Securely</button>

        <% } else { %>

            <h1>Welcome to SkillSwap</h1>
            <h2>Log In</h2>

            <form id="loginForm">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Log In</button>
            </form>
            
            <p id="messageArea" style="color: red; margin-top: 10px;"></p>

            <hr>
            
            <p>New Student? <a href="/register">Create an Account Here</a></p>

        <% } %> </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // --- Client-Side JavaScript Logic ---
        
        const messageArea = document.getElementById('messageArea');

        // Logic runs only if the login form exists (i.e., if the user is NOT logged in)
        if (document.getElementById('loginForm')) {
            document.getElementById('loginForm').addEventListener('submit', handleLoginSubmit);
        }

        // Logic runs only if the logout button exists (i.e., if the user IS logged in)
        if (document.getElementById('logoutButton')) {
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
        }

        async function handleLoginSubmit(event) {
            event.preventDefault(); 
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            messageArea.textContent = ''; 

            try {
                // Axios POST request to the Express API
                const response = await axios.post('/api/login', {
                    email: email,
                    password: password
                });

                if (response.status === 200) {
                    messageArea.textContent = 'Login Successful! Redirecting...';
                    messageArea.style.color = 'green';
                    
                    // On success, simply reload the page to load the authenticated dashboard view
                    window.location.href = '/'; 
                }

            } catch (error) {
                let errorMessage = 'An unexpected error occurred.';
                if (error.response) {
                    errorMessage = error.response.data.message || errorMessage;
                }
                
                messageArea.textContent = errorMessage;
                messageArea.style.color = 'red';
                console.error('Login Failed:', errorMessage);
            }
        }

        async function handleLogout() {
             try {
                // Axios POST request to the secure logout endpoint
                const response = await axios.post('/api/logout');

                if (response.status === 200) {
                    // On successful destruction of the server session, redirect to the login page
                    window.location.href = '/'; 
                }

            } catch (error) {
                alert('Logout failed. Please try clearing cookies manually.');
                console.error('Logout Failed:', error);
            }
        }

        // --- SEARCH LOGIC ---
        const searchInput = document.getElementById('searchInput');
        const resultsBox = document.getElementById('searchResults');

        if (searchInput) {
            // Debounce: Wait 300ms after typing stops to send request
            let timeout = null;

            searchInput.addEventListener('input', (e) => {
                clearTimeout(timeout);
                const query = e.target.value.trim();

                if (query.length < 2) {
                    resultsBox.style.display = 'none';
                    return;
                }

                timeout = setTimeout(async () => {
                    try {
                        const response = await axios.get(`/api/search?q=${encodeURIComponent(query)}`);
                        const results = response.data.results;
                        
                        resultsBox.innerHTML = '';
                        
                        if (results.length === 0) {
                            resultsBox.innerHTML = '<div style="padding:15px; color:#666;">No results found.</div>';
                        } else {
                            results.forEach(item => {
                                // Logic: If it's a skill match, show "Teaches: [Skill]". 
                                // If it's a user match, show "Grade: [Grade]"
                                // We now grab BOTH from the unified 'sub_text' property.
                                
                                const subText = item.type === 'skill_match' 
                                    ? `Teaches: <strong>${item.sub_text}</strong>` 
                                    : `Grade: ${item.sub_text || 'N/A'}`;
                                
                                const div = document.createElement('div');
                                div.style.padding = '10px 15px';
                                div.style.borderBottom = '1px solid #eee';
                                div.style.cursor = 'pointer';
                                div.innerHTML = `
                                    <div style="font-weight:bold; color:#2563eb;">${item.user_name}</div>
                                    <div style="font-size:0.85em; color:#555;">${subText}</div>
                                `;
                                div.onclick = () => window.location.href = `/profile/view/${item.user_id}`;
                                div.onmouseover = () => div.style.background = '#f9fafb';
                                div.onmouseout = () => div.style.background = 'white';
                                
                                resultsBox.appendChild(div);
                            });
                        }
                        resultsBox.style.display = 'block';

                    } catch (err) {
                        console.error("Search failed", err);
                    }
                }, 300);
            });

            // Close dropdown if clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
                    resultsBox.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>