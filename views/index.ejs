<!DOCTYPE html>
<html>
<head>
    <title>SkillSwap - <%= user ? 'Dashboard' : 'Login' %></title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    
    <main>
        
        <% if (user) { %>
        
            <h1>Welcome Back, <%= user.name %>!</h1>
            <p>You are logged in as a <%= user.isAdmin ? 'Platform Administrator' : 'Student User' %>.</p>

            <hr>

            <h2>Quick Links</h2>
            <ul>
                <li><a href="/profile/edit">Edit Your Profile and Skills</a></li>
                <li><a href="/my_sessions">View My Sessions and Requests</a></li>
                <% if (user.isAdmin) { %>
                    <li><a href="/admin">Go to Admin Control Panel (Security and User Management)</a></li>
                <% } %>
            </ul>
            
            <button id="logoutButton">Log Out Securely</button>

        <% } else { %>

            <h1>Welcome to SkillSwap</h1>
            <h2>Log In</h2>

            <form id="loginForm">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Log In</button>
            </form>
            
            <p id="messageArea" style="color: red; margin-top: 10px;"></p>

            <hr>
            
            <p>New Student? <a href="/register">Create an Account Here</a></p>

        <% } %>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // --- Client-Side JavaScript Logic ---
        
        const messageArea = document.getElementById('messageArea');

        // Logic runs only if the login form exists (i.e., if the user is NOT logged in)
        if (document.getElementById('loginForm')) {
            document.getElementById('loginForm').addEventListener('submit', handleLoginSubmit);
        }

        // Logic runs only if the logout button exists (i.e., if the user IS logged in)
        if (document.getElementById('logoutButton')) {
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
        }

        async function handleLoginSubmit(event) {
            event.preventDefault(); 
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            messageArea.textContent = ''; 

            try {
                // Axios POST request to the Express API
                const response = await axios.post('/api/login', {
                    email: email,
                    password: password
                });

                if (response.status === 200) {
                    messageArea.textContent = 'Login Successful! Redirecting...';
                    messageArea.style.color = 'green';
                    
                    // On success, simply reload the page to load the authenticated dashboard view
                    window.location.href = '/'; 
                }

            } catch (error) {
                let errorMessage = 'An unexpected error occurred.';
                if (error.response) {
                    errorMessage = error.response.data.message || errorMessage;
                }
                
                messageArea.textContent = errorMessage;
                messageArea.style.color = 'red';
                console.error('Login Failed:', errorMessage);
            }
        }

        async function handleLogout() {
             try {
                // Axios POST request to the secure logout endpoint
                const response = await axios.post('/api/logout');

                if (response.status === 200) {
                    // On successful destruction of the server session, redirect to the login page
                    window.location.href = '/'; 
                }

            } catch (error) {
                alert('Logout failed. Please try clearing cookies manually.');
                console.error('Logout Failed:', error);
            }
        }
    </script>
</body>
</html>