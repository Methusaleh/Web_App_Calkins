<!DOCTYPE html>
<html>
<head>
    <title>SkillSwap - <%= user ? 'Dashboard' : 'Login' %></title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    
    <main>
        
        <% if (user) { %>
        
            <h1>Welcome Back, <%= user.name %>!</h1>
            <p>You are logged in as a <%= user.isAdmin ? 'Platform Administrator' : 'Student User' %>.</p>

            <hr>

            <h2>Quick Links</h2>

            <div class="dashboard-actions" style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; flex: 1; min-width: 200px;">
                    <h3>üë§ Your Profile</h3>
                    <p>Keep your skills and details up to date.</p>
                    
                    <a href="/profile/edit" style="display:inline-block; margin-top:10px; font-weight:bold;">Edit Profile &rarr;</a>
                    
                    <br>
                    <a href="/profile/view/<%= user.id %>" style="display:inline-block; margin-top:10px; color: #555; font-size: 0.9em; text-decoration: none;">
                        üëÅÔ∏è View Public Profile
                    </a>
                </div>

                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; flex: 1; min-width: 200px;">
                    <h3>üìÖ Your Sessions</h3>
                    <p>View upcoming lessons or check requests.</p>
                    <a href="/my_sessions" style="display:inline-block; margin-top:10px; font-weight:bold;">Manage Sessions &rarr;</a>
                </div>

                <% if (user.isAdmin) { %>
                    <div style="border: 1px solid #fca5a5; background: #fef2f2; padding: 15px; border-radius: 8px; flex: 1; min-width: 200px;">
                        <h3 style="color:#991b1b;">üõ°Ô∏è Admin Panel</h3>
                        <p>Manage users and security reports.</p>
                        <a href="/admin" style="display:inline-block; margin-top:10px; font-weight:bold; color:#991b1b;">Open Controls &rarr;</a>
                    </div>
                <% } %>
            </div>
            
            <br>
            <button id="logoutButton">Log Out Securely</button>

        <% } else { %>

            <h1>Welcome to SkillSwap</h1>
            <h2>Log In</h2>

            <form id="loginForm">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Log In</button>
            </form>
            
            <p id="messageArea" style="color: red; margin-top: 10px;"></p>

            <hr>
            
            <p>New Student? <a href="/register">Create an Account Here</a></p>

        <% } %> </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // --- Client-Side JavaScript Logic ---
        
        const messageArea = document.getElementById('messageArea');

        // Logic runs only if the login form exists (i.e., if the user is NOT logged in)
        if (document.getElementById('loginForm')) {
            document.getElementById('loginForm').addEventListener('submit', handleLoginSubmit);
        }

        // Logic runs only if the logout button exists (i.e., if the user IS logged in)
        if (document.getElementById('logoutButton')) {
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
        }

        async function handleLoginSubmit(event) {
            event.preventDefault(); 
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            messageArea.textContent = ''; 

            try {
                // Axios POST request to the Express API
                const response = await axios.post('/api/login', {
                    email: email,
                    password: password
                });

                if (response.status === 200) {
                    messageArea.textContent = 'Login Successful! Redirecting...';
                    messageArea.style.color = 'green';
                    
                    // On success, simply reload the page to load the authenticated dashboard view
                    window.location.href = '/'; 
                }

            } catch (error) {
                let errorMessage = 'An unexpected error occurred.';
                if (error.response) {
                    errorMessage = error.response.data.message || errorMessage;
                }
                
                messageArea.textContent = errorMessage;
                messageArea.style.color = 'red';
                console.error('Login Failed:', errorMessage);
            }
        }

        async function handleLogout() {
             try {
                // Axios POST request to the secure logout endpoint
                const response = await axios.post('/api/logout');

                if (response.status === 200) {
                    // On successful destruction of the server session, redirect to the login page
                    window.location.href = '/'; 
                }

            } catch (error) {
                alert('Logout failed. Please try clearing cookies manually.');
                console.error('Logout Failed:', error);
            }
        }
    </script>
</body>
</html>