<!DOCTYPE html>
<html>
<head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css">
    <style>
        /* styles for the list of conversations */
        .inbox-list { list-style: none; padding: 0; }
        
        /* individual conversation row styling */
        .inbox-item { 
            display: flex; justify-content: space-between; align-items: center;
            background: white; border: 1px solid #eee; 
            padding: 15px; margin-bottom: 10px; border-radius: 6px;
            text-decoration: none; color: inherit; transition: background 0.2s;
        }
        .inbox-item:hover { background: #f9fafb; border-color: #ccc; }
        
        /* styling for names and message previews */
        .inbox-name { font-weight: bold; font-size: 1.1em; color: #ea5455cc; }
        .inbox-preview { color: #666; font-size: 0.9em; margin-top: 5px; }
        .inbox-time { font-size: 0.8em; color: #999; white-space: nowrap; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <%- include('partials/navbar') %>

    <main>
        <div style="margin-bottom: 20px;">
            <a href="/" style="text-decoration: none; color: #333; font-weight: bold;">&larr; Back to Dashboard</a>
        </div>

        <h1>My Inbox</h1>
        <p id="loadingMsg">Loading conversations...</p>
        <ul id="inboxList" class="inbox-list"></ul>
    </main>
    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // helper function to show toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            // triggers the slide in animation
            requestAnimationFrame(() => toast.classList.add('show'));
            
            // removes the toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // load conversations when the page finishes loading
        document.addEventListener('DOMContentLoaded', async () => {
            const list = document.getElementById('inboxList');
            const loading = document.getElementById('loadingMsg');

            try {
                // fetch the list of active conversations from the api
                const response = await axios.get('/api/messages/inbox');
                const conversations = response.data.conversations;

                // hide the loading text once data is received
                loading.style.display = 'none';

                // show a message if the inbox is empty
                if (conversations.length === 0) {
                    list.innerHTML = '<p>No messages yet.</p>';
                    return;
                }

                // loop through each conversation and create a list item
                conversations.forEach(convo => {
                    const time = new Date(convo.timestamp).toLocaleDateString() + ' ' + new Date(convo.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // build the html for the conversation row
                    const item = `
                        <a href="/messages/${convo.other_user_id}" class="inbox-item">
                            <div>
                                <div class="inbox-name">${convo.other_user_name}</div>
                                <div class="inbox-preview">${convo.message_text.substring(0, 50)}...</div>
                            </div>
                            <div class="inbox-time">${time}</div>
                        </a>
                    `;
                    list.innerHTML += item;
                });

            } catch (error) {
                console.error(error);
                loading.textContent = 'Error loading messages.';
                showToast("Failed to load inbox.", "error");
            }
        });
    </script>
</body>
</html>
