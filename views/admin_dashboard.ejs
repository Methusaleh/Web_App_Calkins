<!DOCTYPE html>
<html>
<head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css">
    <style>
        .admin-section { margin-bottom: 40px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #eaeaea; }
        .btn-small { padding: 4px 8px; font-size: 0.8em; cursor: pointer; }
        .btn-danger { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .btn-success { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    </style>
</head>
<body>
    <main>
        <div style="margin-bottom: 20px;">
            <a href="/" style="text-decoration: none; color: #333; font-weight: bold;">&larr; Back to Main Dashboard</a>
        </div>

        <h1>Admin Control Panel</h1>
        <p>Monitor activity, manage users, and curate skills.</p>

        <div class="admin-section">
            <h2>1. Pending Skill Suggestions</h2>
            <p>Review skills suggested by users.</p>
            <table id="suggestionsTable">
                <thead>
                    <tr>
                        <th>Suggested Skill</th>
                        <th>Suggested By</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="suggestionsBody"><tr><td colspan="4">Loading...</td></tr></tbody>
            </table>
        </div>

        <div class="admin-section">
            <h2>2. Security Reports</h2>
            <p>Monitor user reports and update their status.</p>
            <table id="reportsTable">
                <thead>
                    <tr>
                        <th>Reported User</th>
                        <th>Reason</th>
                        <th>Reporter</th>
                        <th>Current Status</th>
                        <th>Update Status</th>
                    </tr>
                </thead>
                <tbody id="reportsBody"><tr><td colspan="5">Loading...</td></tr></tbody>
            </table>
        </div>

        <div class="admin-section">
            <h2>3. User Database</h2>
            <p>View all registered users and remove accounts if necessary.</p>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Grade</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersBody"><tr><td colspan="5">Loading...</td></tr></tbody>
            </table>
        </div>
        
        <div class="admin-section">
            <h2>4. Add Master Skill Manually</h2>
            <form id="addSkillForm" style="display:flex; gap:10px;">
                <input type="text" id="newMasterSkill" placeholder="New Skill Name" required style="flex-grow:1;">
                <button type="submit">Add Skill</button>
            </form>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchSuggestions();
            fetchReports();
            fetchUsers();
        });

        // --- 1. SKILL SUGGESTIONS LOGIC ---
        async function fetchSuggestions() {
            const tbody = document.getElementById('suggestionsBody');
            try {
                const res = await axios.get('/api/admin/suggestions');
                const data = res.data.suggestions;
                tbody.innerHTML = '';

                if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="4">No pending suggestions.</td></tr>'; return; }

                data.forEach(item => {
                    const row = `<tr>
                        <td>${item.suggested_skill_name}</td>
                        <td>${item.suggesting_user || 'Unknown'}</td>
                        <td>${new Date(item.timestamp).toLocaleDateString()}</td>
                        <td>
                            <button class="btn-small btn-success" onclick="processSuggestion(${item.suggestion_id}, 'approve')">Approve</button>
                            <button class="btn-small btn-danger" onclick="processSuggestion(${item.suggestion_id}, 'reject')">Reject</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) { console.error(err); tbody.innerHTML = '<tr><td colspan="4">Error loading data.</td></tr>'; }
        }

        async function processSuggestion(id, action) {
            try {
                await axios.post('/api/admin/suggestions/action', { suggestionId: id, action: action });
                fetchSuggestions(); // Refresh table
            } catch (err) { alert('Error processing suggestion.'); }
        }

        // --- 2. REPORTS LOGIC ---
        async function fetchReports() {
            const tbody = document.getElementById('reportsBody');
            try {
                const res = await axios.get('/api/admin/reports');
                const data = res.data.reports;
                tbody.innerHTML = '';

                if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5">No active reports.</td></tr>'; return; }

                data.forEach(item => {
                    const row = `<tr>
                        <td><strong>${item.reported_user_name}</strong> (ID: ${item.reported_user_id})</td>
                        <td>${item.report_reason}</td>
                        <td>${item.reporter_name}</td>
                        <td style="font-weight:bold;">${item.report_status}</td>
                        <td>
                            <select onchange="updateReportStatus(${item.report_id}, this.value)">
                                <option value="">-- Change Status --</option>
                                <option value="Under Review">Under Review</option>
                                <option value="Action Taken">Action Taken</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) { console.error(err); tbody.innerHTML = '<tr><td colspan="5">Error loading reports.</td></tr>'; }
        }

        async function updateReportStatus(id, newStatus) {
            if(!newStatus) return;
            try {
                await axios.post(`/api/admin/report/${id}/status`, { newStatus: newStatus });
                fetchReports(); // Refresh table
            } catch (err) { alert('Error updating status.'); }
        }

        // --- 3. USER MANAGEMENT LOGIC ---
        async function fetchUsers() {
            const tbody = document.getElementById('usersBody');
            try {
                const res = await axios.get('/api/admin/users');
                const data = res.data.users;
                tbody.innerHTML = '';

                data.forEach(u => {
                    const row = `<tr>
                        <td>${u.user_id}</td>
                        <td>${u.user_name} ${u.is_admin ? '<strong>(Admin)</strong>' : ''}</td>
                        <td>${u.email}</td>
                        <td>${u.grade_level || '-'}</td>
                        <td>
                            ${!u.is_admin ? `<button class="btn-small btn-danger" onclick="deleteUser(${u.user_id})">Delete</button>` : 'Protected'}
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) { console.error(err); tbody.innerHTML = '<tr><td colspan="5">Error loading users.</td></tr>'; }
        }

        async function deleteUser(id) {
            if(!confirm(`Are you sure you want to permanently DELETE User ID ${id}? This cannot be undone.`)) return;
            try {
                await axios.delete(`/api/admin/users/${id}`);
                fetchUsers(); // Refresh list
            } catch (err) { alert('Error deleting user.'); }
        }

        // --- 4. MANUAL ADD SKILL LOGIC ---
        document.getElementById('addSkillForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newMasterSkill').value;
            try {
                await axios.post('/api/skills', { skillName: name });
                alert('Skill added to master list!');
                document.getElementById('newMasterSkill').value = '';
            } catch (err) { alert('Error adding skill (it may already exist).'); }
        });

    </script>
</body>
</html>