

/* ==========================================================================
   FILE: hash_admin.js
   ========================================================================== */

import bcrypt from 'bcryptjs';


const ADMIN_PASSWORD = "Amacmoneyman49!"; 

const saltRounds = 10;

async function hashAdminPassword() {
    try {
        const hashedPassword = await bcrypt.hash(ADMIN_PASSWORD, saltRounds);
        console.log("-----------------------------------------------------------------");
        console.log(`Password to insert: ${hashedPassword}`);
        console.log("-----------------------------------------------------------------");
        process.exit(0);
    } catch (error) {
        console.error("Error hashing password:", error);
        process.exit(1);
    }
}

hashAdminPassword();

/* ==========================================================================
   FILE: index.js
   ========================================================================== */

import express from "express";
import session from "express-session";
import pgSession from "connect-pg-simple";
import bodyParser from "body-parser";
import pg from "pg";
import bcrypt from "bcryptjs";
import morgan from "morgan";
import cors from "cors";
import path from "path";
import { fileURLToPath } from "url";
import { dirname } from "path";

// setup for the express app and database connection
const app = express();
const port = process.env.PORT || 8080;
const { Pool } = pg;
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const PgSession = pgSession(session);

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});

// configure the view engine to use ejs templates
app.set("view engine", "ejs");
app.set("views", path.join(__dirname, "views"));

// configure session middleware to store logins in the database
app.use(
  session({
    store: new PgSession({
      pool: pool,
      tableName: "session",
    }),
    secret: process.env.SESSION_SECRET || "a-long-random-string-placeholder",
    resave: false,
    saveUninitialized: false,
    cookie: {
      maxAge: 30 * 24 * 60 * 60 * 1000, // 30 days
      secure: "auto",
    },
  })
);

// setup standard middleware for parsing data and logging
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());
app.use(morgan("combined"));
app.use(cors());
app.use(express.static(path.join(__dirname, "public")));

// middleware to check if a user is logged in
function isAuthenticated(req, res, next) {
  if (req.session.user) {
    req.user = req.session.user;
    next();
  } else {
    if (req.originalUrl.startsWith("/api/")) {
      res.status(401).json({ message: "Unauthorized. Please log in." });
    } else {
      res.redirect("/");
    }
  }
}

// middleware to check if a user is an administrator
function isAdmin(req, res, next) {
  if (req.session.user && req.session.user.isAdmin) {
    req.user = req.session.user;
    next();
  } else {
    if (req.originalUrl.startsWith("/api/")) {
      res
        .status(403)
        .json({ message: "Access denied. Administrator privileges required." });
    } else {
      res.redirect("/");
    }
  }
}

// function to create database tables if they do not exist
async function createTables() {
  const tableCreationQueries = `
        CREATE TABLE IF NOT EXISTS Users (
            user_id SERIAL PRIMARY KEY,
            email VARCHAR(100) UNIQUE NOT NULL,
            password_hash VARCHAR(255) NOT NULL,
            user_name VARCHAR(100) NOT NULL,
            date_of_birth DATE NOT NULL,
            grade_level VARCHAR(20),
            school_college VARCHAR(100),
            is_admin BOOLEAN DEFAULT FALSE,
            avatar_style VARCHAR(50) DEFAULT 'bottts'
        );
        CREATE TABLE IF NOT EXISTS Skills (
            skill_id SERIAL PRIMARY KEY,
            skill_name VARCHAR(50) UNIQUE NOT NULL
        );
        CREATE TABLE IF NOT EXISTS User_Skills_Offered (
            user_skill_id SERIAL PRIMARY KEY,
            user_id INT NOT NULL REFERENCES Users(user_id) ON DELETE CASCADE,
            skill_id INT NOT NULL REFERENCES Skills(skill_id) ON DELETE CASCADE,
            is_virtual_only BOOLEAN DEFAULT FALSE,
            is_inperson_only BOOLEAN DEFAULT FALSE,
            UNIQUE (user_id, skill_id)
        );
        CREATE TABLE IF NOT EXISTS User_Skills_Sought (
            user_skill_id SERIAL PRIMARY KEY,
            user_id INT NOT NULL REFERENCES Users(user_id) ON DELETE CASCADE,
            skill_id INT NOT NULL REFERENCES Skills(skill_id) ON DELETE CASCADE,
            is_virtual_only BOOLEAN DEFAULT FALSE,
            is_inperson_only BOOLEAN DEFAULT FALSE,
            UNIQUE (user_id, skill_id)
        );
        CREATE TABLE IF NOT EXISTS Sessions (
            session_id SERIAL PRIMARY KEY,
            provider_id INT NOT NULL REFERENCES Users(user_id) ON DELETE CASCADE,
            requester_id INT NOT NULL REFERENCES Users(user_id) ON DELETE CASCADE,
            skill_taught_id INT NOT NULL REFERENCES Skills(skill_id) ON DELETE CASCADE,
            session_date_time TIMESTAMP WITH TIME ZONE NOT NULL,
            location_type VARCHAR(20) NOT NULL,
            status VARCHAR(20) DEFAULT 'Requested',
            meeting_url VARCHAR(255),
            cancellation_reason TEXT,
            CONSTRAINT check_self_session CHECK (provider_id <> requester_id) 
        );
        CREATE TABLE IF NOT EXISTS Ratings (
            rating_id SERIAL PRIMARY KEY,
            session_id INT UNIQUE NOT NULL REFERENCES Sessions(session_id) ON DELETE CASCADE,
            rater_id INT NOT NULL REFERENCES Users(user_id) ON DELETE CASCADE,
            ratee_id INT NOT NULL REFERENCES Users(user_id) ON DELETE CASCADE,
            like_status BOOLEAN NOT NULL,
            feedback_text TEXT,
            CONSTRAINT check_rating_users CHECK (rater_id <> ratee_id)
        );
        CREATE TABLE IF NOT EXISTS Reports (
            report_id SERIAL PRIMARY KEY,
            reporter_id INT NOT NULL REFERENCES Users(user_id) ON DELETE CASCADE,
            reported_user_id INT NOT NULL REFERENCES Users(user_id) ON DELETE CASCADE,
            report_reason VARCHAR(255) NOT NULL,
            report_status VARCHAR(20) DEFAULT 'New',
            timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
        );
        CREATE TABLE IF NOT EXISTS Messages (
            message_id SERIAL PRIMARY KEY,
            sender_id INT NOT NULL REFERENCES Users(user_id) ON DELETE CASCADE,
            receiver_id INT NOT NULL REFERENCES Users(user_id) ON DELETE CASCADE,
            message_text TEXT NOT NULL,
            timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
            is_read BOOLEAN DEFAULT FALSE
        );
        CREATE TABLE IF NOT EXISTS Skill_Suggestions (
            suggestion_id SERIAL PRIMARY KEY,
            suggested_skill_name VARCHAR(100) UNIQUE NOT NULL,
            suggesting_user_id INT REFERENCES Users(user_id) ON DELETE SET NULL,
            status VARCHAR(20) DEFAULT 'Pending', 
            timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
        );
        CREATE TABLE IF NOT EXISTS session (
            sid varchar NOT NULL COLLATE "default" PRIMARY KEY,
            sess json NOT NULL,
            expire timestamp(6) with time zone NOT NULL
        );
        CREATE TABLE IF NOT EXISTS Admin_Logs (
            log_id SERIAL PRIMARY KEY,
            admin_id INT NOT NULL REFERENCES Users(user_id) ON DELETE CASCADE,
            action_type VARCHAR(50) NOT NULL,
            target_table VARCHAR(50),
            target_id INT,
            timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
        );
    `;
  try {
    await pool.query(tableCreationQueries);
    console.log("PostgreSQL: All tables created successfully.");
    return true;
  } catch (error) {
    console.error("CRITICAL: Failed to create tables:", error.message);
    return false;
  }
}

// landing page route
app.get("/", (req, res) => {
  // if user is logged in send them to dashboard
  if (req.session.user) {
    return res.redirect("/dashboard");
  }
  res.render("landing");
});

// About / Tech Spec Page
app.get("/about", (req, res) => {
  res.render("about", {
    pageTitle: "About SkillSwap",
    user: req.session.user || null,
  });
});

// dashboard route
app.get("/dashboard", async (req, res) => {
  let dbStatus = "Failed";
  let dbVersion = "Error";

  // setup database tables
  const tablesReady = await createTables();
  const user = req.session.user || null;
  let topTeachers = [];

  if (tablesReady) {
    try {
      // check connection
      const result = await pool.query("SELECT version()");
      dbVersion = result.rows[0].version;
      dbStatus = "Success";

      // get top rated teachers
      const topTeachersRes = await pool.query(
        `SELECT u.user_id, u.user_name, u.avatar_style, COUNT(r.rating_id) as like_count
                 FROM Users u
                 JOIN Ratings r ON u.user_id = r.ratee_id
                 WHERE r.like_status = TRUE
                 GROUP BY u.user_id, u.user_name, u.avatar_style
                 ORDER BY like_count DESC LIMIT 3`
      );
      topTeachers = topTeachersRes.rows;
    } catch (error) {
      console.error("db error:", error.message);
    }
  }

  // render the main app view
  res.render("index", { dbStatus, dbVersion, user, topTeachers });
});

// login route fix
app.get("/login", (req, res) => {
  res.redirect("/dashboard");
});

// loads the registration page if the user is not logged in
app.get("/register", async (req, res) => {
  if (req.session.user) return res.redirect("/");
  res.render("register", { pageTitle: "Register", user: null });
});

// handles user registration by saving new account details to the database
app.post("/api/register", async (req, res) => {
  const {
    email,
    password,
    userName,
    dateOfBirth,
    gradeLevel,
    schoolCollege,
    avatarStyle,
  } = req.body;
  if (!email || !password || !userName || !dateOfBirth)
    return res.status(400).json({ message: "Missing fields." });

  try {
    const checkUser = await pool.query(
      "SELECT user_id FROM Users WHERE email = $1",
      [email]
    );
    if (checkUser.rows.length > 0)
      return res.status(409).json({ message: "Email already registered." });

    const hashedPassword = await bcrypt.hash(password, 10);
    const result = await pool.query(
      `INSERT INTO Users (email, password_hash, user_name, date_of_birth, grade_level, school_college, is_admin, avatar_style) 
             VALUES ($1, $2, $3, $4, $5, $6, FALSE, $7) RETURNING user_id, user_name, email`,
      [
        email,
        hashedPassword,
        userName,
        dateOfBirth,
        gradeLevel || null,
        schoolCollege || null,
        avatarStyle || "bottts",
      ]
    );
    res
      .status(201)
      .json({ message: "Registered successfully.", user: result.rows[0] });
  } catch (error) {
    res.status(500).json({ message: "Server error.", error: error.message });
  }
});

// handles user login by verifying password and creating a session
app.post("/api/login", async (req, res) => {
  const { email, password } = req.body;
  if (!email || !password)
    return res.status(400).json({ message: "Email and password required." });

  try {
    const result = await pool.query(
      "SELECT user_id, email, password_hash, user_name, is_admin, avatar_style FROM Users WHERE email = $1",
      [email]
    );
    const user = result.rows[0];
    if (!user || !(await bcrypt.compare(password, user.password_hash))) {
      return res.status(401).json({ message: "Invalid credentials." });
    }

    req.session.user = {
      id: user.user_id,
      name: user.user_name,
      email: user.email,
      isAdmin: user.is_admin,
      avatarStyle: user.avatar_style || "bottts",
    };
    res
      .status(200)
      .json({ message: "Login successful.", user: req.session.user });
  } catch (error) {
    res.status(500).json({ message: "Login error.", error: error.message });
  }
});

// logs the user out by destroying the current session
app.post("/api/logout", (req, res) => {
  if (req.session)
    req.session.destroy((err) => {
      if (err) return res.status(500).json({ message: "Logout failed." });
      res.status(200).json({ message: "Logout successful." });
    });
  else res.status(200).json({ message: "No session." });
});

// renders the profile editing page and loads the master list of skills
app.get("/profile/edit", isAuthenticated, async (req, res) => {
  try {
    const skillsResult = await pool.query(
      "SELECT skill_id, skill_name FROM Skills ORDER BY skill_name ASC"
    );
    res.render("profile_edit", {
      pageTitle: "Edit Profile",
      user: req.user,
      masterSkills: skillsResult.rows,
    });
  } catch (error) {
    res.status(500).send("Error loading profile.");
  }
});

// --- password reset section ---

// show the forgot password form
app.get("/forgot-password", (req, res) => {
  res.render("forgot_password");
});

// handle the form submission
app.post("/forgot-password", async (req, res) => {
  const { email } = req.body;

  // create a random token
  const token =
    Math.random().toString(36).substring(2) + Date.now().toString(36);
  const oneHour = 3600000;
  const expires = Date.now() + oneHour;

  try {
    // save token to db
    const result = await pool.query(
      "UPDATE Users SET reset_token = $1, reset_expires = $2 WHERE email = $3 RETURNING user_name",
      [token, expires, email]
    );

    if (result.rows.length > 0) {
      // success: render the 'sent' page and pass the token for the demo button
      res.render("forgot_password_sent", {
        email: email,
        token: token,
      });
    } else {
      // security: for this project we will just show the same page to avoid fishing
      // but in a real app you might warn them
      res.render("forgot_password_sent", {
        email: email,
        token: null,
      });
    }
  } catch (e) {
    console.error(e);
    res.status(500).send("Error.");
  }
});

// show the new password form
app.get("/reset-password/:token", async (req, res) => {
  const { token } = req.params;

  // check if token exists and is valid
  const result = await pool.query(
    "SELECT user_id FROM Users WHERE reset_token = $1 AND reset_expires > $2",
    [token, Date.now()]
  );

  if (result.rows.length === 0) {
    return res.send("This password reset link is invalid or has expired.");
  }

  res.render("reset_password", { token });
});

// update the password
app.post("/reset-password/:token", async (req, res) => {
  const { token } = req.params;
  const { newPassword } = req.body;

  // hash the new password
  const hashedPassword = await bcrypt.hash(newPassword, 10);

  try {
    // update password and clear token
    await pool.query(
      "UPDATE Users SET password_hash = $1, reset_token = NULL, reset_expires = NULL WHERE reset_token = $2",
      [hashedPassword, token]
    );

    res.redirect("/login");
  } catch (e) {
    console.error(e);
    res.status(500).send("Error resetting password.");
  }
});

// renders the public view of a user profile with skills and ratings
app.get("/profile/view/:id", isAuthenticated, async (req, res) => {
  const targetId = req.params.id;
  try {
    const [userRes, offeredRes, soughtRes, ratingRes] = await Promise.all([
      pool.query(
        "SELECT user_id, user_name, grade_level, school_college, email, avatar_style FROM Users WHERE user_id = $1",
        [targetId]
      ),
      pool.query(
        "SELECT s.skill_name, uso.is_virtual_only, uso.is_inperson_only FROM User_Skills_Offered uso JOIN Skills s ON uso.skill_id = s.skill_id WHERE uso.user_id = $1",
        [targetId]
      ),
      pool.query(
        "SELECT s.skill_name FROM User_Skills_Sought uss JOIN Skills s ON uss.skill_id = s.skill_id WHERE uss.user_id = $1",
        [targetId]
      ),
      pool.query(
        "SELECT COUNT(rating_id) AS total, SUM(CASE WHEN like_status = TRUE THEN 1 ELSE 0 END) AS likes FROM Ratings WHERE ratee_id = $1",
        [targetId]
      ),
    ]);

    if (userRes.rows.length === 0)
      return res.status(404).send("User not found.");

    const ratings = ratingRes.rows[0];
    const percent =
      ratings.total > 0 ? Math.round((ratings.likes / ratings.total) * 100) : 0;

    res.render("profile_view", {
      pageTitle: `${userRes.rows[0].user_name}'s Profile`,
      user: req.user,
      profile: userRes.rows[0],
      skillsOffered: offeredRes.rows,
      skillsSought: soughtRes.rows,
      ratingStats: { count: ratings.total, likes: ratings.likes, percent },
    });
  } catch (error) {
    res.status(500).send("Error loading profile.");
  }
});

// updates the basic profile info like name and grade level
app.put("/api/user/profile/:id", isAuthenticated, async (req, res) => {
  if (req.user.id !== parseInt(req.params.id))
    return res.status(403).json({ message: "Access denied." });
  const { userName, gradeLevel, avatarStyle } = req.body;

  try {
    const result = await pool.query(
      "UPDATE Users SET user_name = $1, grade_level = $2, avatar_style = $3 WHERE user_id = $4 RETURNING user_name, avatar_style",
      [userName, gradeLevel || null, avatarStyle || "bottts", req.params.id]
    );
    req.session.user.name = result.rows[0].user_name;
    req.session.user.avatarStyle = result.rows[0].avatar_style;
    req.session.save();
    res.status(200).json({ message: "Profile updated." });
  } catch (error) {
    res.status(500).json({ message: "Update failed." });
  }
});

// fetches the current list of skills a user offers and seeks
app.get("/api/user/skills/:id", isAuthenticated, async (req, res) => {
  try {
    const offered = await pool.query(
      "SELECT skill_id, is_virtual_only, is_inperson_only FROM User_Skills_Offered WHERE user_id = $1",
      [req.params.id]
    );
    const sought = await pool.query(
      "SELECT skill_id, is_virtual_only, is_inperson_only FROM User_Skills_Sought WHERE user_id = $1",
      [req.params.id]
    );
    res.status(200).json({ offered: offered.rows, sought: sought.rows });
  } catch (error) {
    res.status(500).json({ message: "Error fetching skills." });
  }
});

// updates the skills a user offers by clearing the old list and inserting new ones
app.post("/api/user/skills/offer", isAuthenticated, async (req, res) => {
  const userId = req.user.id;
  const { skills } = req.body;
  const client = await pool.connect();
  try {
    await client.query("BEGIN");
    await client.query("DELETE FROM User_Skills_Offered WHERE user_id = $1", [
      userId,
    ]);
    if (skills.length > 0) {
      const queries = skills.map((s) =>
        client.query(
          "INSERT INTO User_Skills_Offered (user_id, skill_id, is_virtual_only, is_inperson_only) VALUES ($1, $2, $3, $4)",
          [
            userId,
            s.skillId,
            s.isVirtualOnly || false,
            s.isInPersonOnly || false,
          ]
        )
      );
      await Promise.all(queries);
    }
    await client.query("COMMIT");
    res.status(200).json({ message: "Offered skills updated." });
  } catch (error) {
    await client.query("ROLLBACK");
    res.status(500).json({ message: "Update failed." });
  } finally {
    client.release();
  }
});

// updates the skills a user wants to learn by clearing old ones and inserting new ones
app.post("/api/user/skills/seek", isAuthenticated, async (req, res) => {
  const userId = req.user.id;
  const { skills } = req.body;
  const client = await pool.connect();
  try {
    await client.query("BEGIN");
    await client.query("DELETE FROM User_Skills_Sought WHERE user_id = $1", [
      userId,
    ]);
    if (skills.length > 0) {
      const queries = skills.map((s) =>
        client.query(
          "INSERT INTO User_Skills_Sought (user_id, skill_id, is_virtual_only, is_inperson_only) VALUES ($1, $2, $3, $4)",
          [
            userId,
            s.skillId,
            s.isVirtualOnly || false,
            s.isInPersonOnly || false,
          ]
        )
      );
      await Promise.all(queries);
    }
    await client.query("COMMIT");
    res.status(200).json({ message: "Sought skills updated." });
  } catch (error) {
    await client.query("ROLLBACK");
    res.status(500).json({ message: "Update failed." });
  } finally {
    client.release();
  }
});

// allows a user to suggest a new skill to be added to the master list
app.post("/api/skills/suggest", isAuthenticated, async (req, res) => {
  const { skillName, userId } = req.body;
  try {
    const exists = await pool.query(
      "SELECT 1 FROM Skills WHERE skill_name ILIKE $1 UNION ALL SELECT 1 FROM Skill_Suggestions WHERE suggested_skill_name ILIKE $1",
      [skillName]
    );
    if (exists.rows.length > 0)
      return res
        .status(409)
        .json({ message: "Skill already exists or is pending." });

    await pool.query(
      "INSERT INTO Skill_Suggestions (suggested_skill_name, suggesting_user_id) VALUES ($1, $2)",
      [skillName, userId]
    );
    res.status(201).json({ message: "Skill suggested successfully." });
  } catch (error) {
    res.status(500).json({ message: "Suggestion failed." });
  }
});

// =================================================================
// 3. SESSIONS & MESSAGES
// =================================================================

// loads the session request form
app.get("/session/request", isAuthenticated, async (req, res) => {
  try {
    const skillsResult = await pool.query(
      "SELECT skill_id, skill_name FROM Skills ORDER BY skill_name ASC"
    );
    res.render("session_request", {
      pageTitle: "Request Session",
      user: req.user,
      skills: skillsResult.rows,
    });
  } catch (error) {
    res.status(500).send("Error loading form.");
  }
});

// renders the main dashboard for managing sessions
app.get("/my_sessions", isAuthenticated, (req, res) => {
  res.render("my_sessions", { pageTitle: "My Sessions", user: req.user });
});

// renders the rating form for a completed session
app.get("/session/rate/:id", isAuthenticated, async (req, res) => {
  try {
    const res1 = await pool.query(
      "SELECT s.*, u.user_name as provider_name FROM Sessions s JOIN Users u ON s.provider_id = u.user_id WHERE s.session_id = $1",
      [req.params.id]
    );
    if (res1.rows.length === 0)
      return res.status(404).send("Session not found");
    const session = res1.rows[0];
    if (session.requester_id !== req.user.id || session.status !== "Completed")
      return res.status(403).send("Invalid session for rating.");
    res.render("rating_form", {
      pageTitle: "Rate Session",
      user: req.user,
      session,
    });
  } catch (err) {
    res.status(500).send("Error");
  }
});

// finds users who teach a specific skill to populate the dropdown
app.get("/api/skills/:id/providers", isAuthenticated, async (req, res) => {
  try {
    const result = await pool.query(
      `SELECT u.user_id, u.user_name FROM Users u JOIN User_Skills_Offered uso ON u.user_id = uso.user_id WHERE uso.skill_id = $1 AND u.is_admin = FALSE AND u.user_id != $2 ORDER BY u.user_name`,
      [req.params.id, req.user.id]
    );
    res.status(200).json({ providers: result.rows });
  } catch (error) {
    res.status(500).json({ message: "Error fetching providers." });
  }
});

// creates a new session request
app.post("/api/sessions/request", isAuthenticated, async (req, res) => {
  const requesterId = req.user.id;
  const {
    providerId,
    skillTaughtId,
    sessionDateTime,
    locationType,
    meetingUrl,
  } = req.body;
  if (!requesterId || !providerId || !sessionDateTime)
    return res.status(400).json({ message: "Missing fields." });
  if (requesterId === providerId)
    return res.status(400).json({ message: "Cannot request self." });

  try {
    await pool.query(
      `INSERT INTO Sessions (provider_id, requester_id, skill_taught_id, session_date_time, location_type, status, meeting_url) 
             VALUES ($1, $2, $3, $4, $5, 'Requested', $6)`,
      [
        providerId,
        requesterId,
        skillTaughtId,
        sessionDateTime,
        locationType,
        meetingUrl || null,
      ]
    );
    res.status(201).json({ message: "Request sent." });
  } catch (error) {
    res.status(500).json({ message: "Request failed." });
  }
});

// fetches the full history of sessions for a user
app.get("/api/sessions/user/:id", isAuthenticated, async (req, res) => {
  try {
    const result = await pool.query(
      `SELECT s.*, p.user_name AS provider_name, r.user_name AS requester_name, sk.skill_name AS skill_name,
            (CASE WHEN rt.rating_id IS NOT NULL THEN TRUE ELSE FALSE END) AS is_rated
            FROM Sessions s
            JOIN Users p ON s.provider_id = p.user_id 
            JOIN Users r ON s.requester_id = r.user_id 
            JOIN Skills sk ON s.skill_taught_id = sk.skill_id
            LEFT JOIN Ratings rt ON s.session_id = rt.session_id
            WHERE s.provider_id = $1 OR s.requester_id = $1 ORDER BY s.session_date_time DESC`,
      [req.params.id]
    );
    res.status(200).json({ sessions: result.rows });
  } catch (error) {
    res.status(500).json({ message: "Error fetching history." });
  }
});

// allows a provider to confirm a session request
app.post("/api/sessions/confirm", isAuthenticated, async (req, res) => {
  const { sessionId, meetingUrl } = req.body;
  try {
    const result = await pool.query(
      `UPDATE Sessions SET status = 'Confirmed', meeting_url = $1 WHERE session_id = $2 AND provider_id = $3 AND status = 'Requested' RETURNING session_id`,
      [meetingUrl || null, sessionId, req.user.id]
    );
    if (result.rows.length === 0)
      return res.status(403).json({ message: "Permission denied." });
    res.status(200).json({ message: "Session confirmed." });
  } catch (error) {
    res.status(500).json({ message: "Error confirming." });
  }
});

// allows a user to deny or cancel a session
app.post("/api/sessions/deny", isAuthenticated, async (req, res) => {
  const { sessionId, reason } = req.body;
  try {
    const sessionRes = await pool.query(
      "SELECT status, requester_id FROM Sessions WHERE session_id = $1",
      [sessionId]
    );
    if (sessionRes.rows.length === 0)
      return res.status(404).json({ message: "Not found." });

    const newStatus =
      req.user.id === sessionRes.rows[0].requester_id ? "Cancelled" : "Denied";
    await pool.query(
      "UPDATE Sessions SET status = $1, cancellation_reason = $2 WHERE session_id = $3",
      [newStatus, reason || "User action", sessionId]
    );
    res.status(200).json({ message: `Session ${newStatus}.` });
  } catch (error) {
    res.status(500).json({ message: "Error denying." });
  }
});

// marks a confirmed session as complete
app.post("/api/sessions/complete", isAuthenticated, async (req, res) => {
  try {
    const result = await pool.query(
      "UPDATE Sessions SET status = 'Completed' WHERE session_id = $1 AND status = 'Confirmed' RETURNING session_id",
      [req.body.sessionId]
    );
    if (result.rows.length === 0)
      return res.status(400).json({ message: "Error completing." });
    res.status(200).json({ message: "Session completed." });
  } catch (e) {
    res.status(500).json({ message: "Server error." });
  }
});

// submits a rating for a completed session
app.post("/api/sessions/rate", isAuthenticated, async (req, res) => {
  const { sessionId, raterId, rateeId, likeStatus, feedbackText } = req.body;
  if (parseInt(raterId) === parseInt(rateeId))
    return res.status(400).json({ message: "Self-rating not allowed." });
  try {
    await pool.query(
      "INSERT INTO Ratings (session_id, rater_id, ratee_id, like_status, feedback_text) VALUES ($1, $2, $3, $4, $5)",
      [sessionId, raterId, rateeId, likeStatus, feedbackText || null]
    );
    res.status(201).json({ message: "Rating submitted." });
  } catch (e) {
    if (e.code === "23505")
      return res.status(409).json({ message: "Already rated." });
    res.status(500).json({ message: "Error rating." });
  }
});

// renders the inbox view
app.get("/messages", isAuthenticated, (req, res) =>
  res.render("inbox", { pageTitle: "My Inbox", user: req.user })
);

// renders the chat view with a specific user
app.get("/messages/:id", isAuthenticated, async (req, res) => {
  try {
    const u = await pool.query(
      "SELECT user_name FROM Users WHERE user_id = $1",
      [req.params.id]
    );
    if (u.rows.length === 0) return res.status(404).send("User not found");
    res.render("chat", {
      pageTitle: "Chat",
      user: req.user,
      otherUser: { id: req.params.id, name: u.rows[0].user_name },
    });
  } catch (e) {
    res.status(500).send("Error");
  }
});

// fetches the list of recent conversations
app.get("/api/messages/inbox", isAuthenticated, async (req, res) => {
  try {
    const result = await pool.query(
      `SELECT DISTINCT ON (other_user_id) other_user_id, other_user_name, message_text, timestamp 
             FROM (SELECT CASE WHEN m.sender_id = $1 THEN m.receiver_id ELSE m.sender_id END AS other_user_id, 
                          CASE WHEN m.sender_id = $1 THEN r.user_name ELSE s.user_name END AS other_user_name, 
                          m.message_text, m.timestamp 
                   FROM Messages m JOIN Users s ON m.sender_id = s.user_id JOIN Users r ON m.receiver_id = r.user_id 
                   WHERE m.sender_id = $1 OR m.receiver_id = $1 ORDER BY m.timestamp DESC) AS recent`,
      [req.user.id]
    );
    res.status(200).json({ conversations: result.rows });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// fetches the message history between two users
app.get(
  "/api/messages/thread/:otherUserId",
  isAuthenticated,
  async (req, res) => {
    try {
      const result = await pool.query(
        `SELECT m.*, u.user_name AS sender_name, u.avatar_style AS sender_avatar_style
             FROM Messages m JOIN Users u ON m.sender_id = u.user_id 
             WHERE (m.sender_id = $1 AND m.receiver_id = $2) OR (m.sender_id = $2 AND m.receiver_id = $1) 
             ORDER BY m.timestamp ASC`,
        [req.user.id, req.params.otherUserId]
      );
      res.status(200).json({ messages: result.rows });
    } catch (e) {
      res.status(500).json({ message: "Error." });
    }
  }
);

// sends a new message to another user
app.post("/api/messages/send", isAuthenticated, async (req, res) => {
  try {
    await pool.query(
      "INSERT INTO Messages (sender_id, receiver_id, message_text) VALUES ($1, $2, $3)",
      [req.user.id, req.body.receiverId, req.body.messageText]
    );
    res.status(201).json({ message: "Sent." });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// =================================================================
// 4. ADMIN PANEL (Protected)
// =================================================================

// renders the main admin dashboard
app.get("/admin", isAdmin, (req, res) => {
  res.render("admin_dashboard", { pageTitle: "Admin Panel", user: req.user });
});

// fetches a list of all users for the admin panel
app.get("/api/admin/users", isAdmin, async (req, res) => {
  try {
    const result = await pool.query(
      "SELECT user_id, email, user_name, grade_level, is_admin FROM Users ORDER BY user_id ASC"
    );
    res.status(200).json({ users: result.rows });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// allows an admin to promote or demote a user
app.post("/api/admin/users/:id/toggle_role", isAdmin, async (req, res) => {
  const targetId = parseInt(req.params.id);
  if (targetId === 1)
    return res.status(403).json({ message: "Cannot change Root Admin." });
  if (targetId === req.user.id)
    return res.status(400).json({ message: "Cannot demote self." });

  try {
    const userCheck = await pool.query(
      "SELECT is_admin FROM Users WHERE user_id = $1",
      [targetId]
    );
    const newStatus = !userCheck.rows[0].is_admin;
    await pool.query("UPDATE Users SET is_admin = $1 WHERE user_id = $2", [
      newStatus,
      targetId,
    ]);
    await pool.query(
      "INSERT INTO Admin_Logs (admin_id, action_type, target_table, target_id) VALUES ($1, $2, 'Users', $3)",
      [req.user.id, newStatus ? "Promote" : "Demote", targetId]
    );
    res.status(200).json({ message: "Role updated." });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// allows an admin to delete a user account
app.delete("/api/admin/users/:id", isAdmin, async (req, res) => {
  const targetId = parseInt(req.params.id);
  if (targetId === 1)
    return res.status(403).json({ message: "Cannot delete Root Admin." });

  try {
    const result = await pool.query(
      "DELETE FROM Users WHERE user_id = $1 RETURNING user_id",
      [targetId]
    );
    if (result.rows.length === 0)
      return res.status(404).json({ message: "Not found." });
    await pool.query(
      "INSERT INTO Admin_Logs (admin_id, action_type, target_table, target_id) VALUES ($1, 'Delete User', 'Users', $2)",
      [req.user.id, targetId]
    );
    res.status(200).json({ message: "User deleted." });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// fetches all security reports for review
app.get("/api/admin/reports", isAdmin, async (req, res) => {
  try {
    const result = await pool.query(
      `SELECT r.*, reporter.user_name AS reporter_name, reported.user_name AS reported_user_name 
             FROM Reports r JOIN Users reporter ON r.reporter_id = reporter.user_id JOIN Users reported ON r.reported_user_id = reported.user_id ORDER BY r.timestamp DESC`
    );
    res.status(200).json({ reports: result.rows });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// updates the status of a security report
app.post("/api/admin/report/:id/status", isAdmin, async (req, res) => {
  try {
    await pool.query(
      "UPDATE Reports SET report_status = $1 WHERE report_id = $2",
      [req.body.newStatus, req.params.id]
    );
    await pool.query(
      "INSERT INTO Admin_Logs (admin_id, action_type, target_table, target_id) VALUES ($1, 'Update Report', 'Reports', $2)",
      [req.user.id, req.params.id]
    );
    res.status(200).json({ message: "Report updated." });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// allows a user to submit a security report against another user
app.post("/api/reports", isAuthenticated, async (req, res) => {
  try {
    await pool.query(
      "INSERT INTO Reports (reporter_id, reported_user_id, report_reason, report_status) VALUES ($1, $2, $3, 'New')",
      [req.user.id, req.body.reportedUserId, req.body.reason]
    );
    res.status(201).json({ message: "Report sent." });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

//  fetches the system audit trail
app.get("/api/admin/logs", isAdmin, async (req, res) => {
  try {
    const result = await pool.query(
      `SELECT l.action_type, l.target_table, l.timestamp, u.user_name 
             FROM Admin_Logs l
             JOIN Users u ON l.admin_id = u.user_id
             ORDER BY l.timestamp DESC LIMIT 50`
    );
    res.status(200).json({ logs: result.rows });
  } catch (e) {
    console.error(e);
    res.status(500).json({ message: "Error fetching logs." });
  }
});

// fetches pending skill suggestions for admin review
app.get("/api/admin/suggestions", isAdmin, async (req, res) => {
  try {
    const res1 = await pool.query(
      "SELECT s.*, u.user_name AS suggesting_user FROM Skill_Suggestions s LEFT JOIN Users u ON s.suggesting_user_id = u.user_id WHERE s.status = 'Pending'"
    );
    res.status(200).json({ suggestions: res1.rows });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// approves or rejects a suggested skill
app.post("/api/admin/suggestions/action", isAdmin, async (req, res) => {
  const { suggestionId, action } = req.body;
  const client = await pool.connect();
  try {
    await client.query("BEGIN");
    const s = await client.query(
      "SELECT suggested_skill_name FROM Skill_Suggestions WHERE suggestion_id = $1",
      [suggestionId]
    );
    if (s.rows.length === 0) throw new Error("Not found");

    if (action === "approve")
      await client.query("INSERT INTO Skills (skill_name) VALUES ($1)", [
        s.rows[0].suggested_skill_name,
      ]);

    await client.query(
      "UPDATE Skill_Suggestions SET status = $1 WHERE suggestion_id = $2",
      [action === "approve" ? "Approved" : "Rejected", suggestionId]
    );
    await client.query(
      "INSERT INTO Admin_Logs (admin_id, action_type, target_table, target_id) VALUES ($1, $2, 'Skill_Suggestions', $3)",
      [
        req.user.id,
        action === "approve" ? "Approve Skill" : "Reject Skill",
        suggestionId,
      ]
    );

    await client.query("COMMIT");
    res.status(200).json({ message: "Processed." });
  } catch (e) {
    await client.query("ROLLBACK");
    res.status(500).json({ message: "Error." });
  } finally {
    client.release();
  }
});

// allows an admin to manually add a new skill
app.post("/api/skills", isAdmin, async (req, res) => {
  try {
    const result = await pool.query(
      "INSERT INTO Skills (skill_name) VALUES ($1) RETURNING skill_id",
      [req.body.skillName]
    );
    await pool.query(
      "INSERT INTO Admin_Logs (admin_id, action_type, target_table, target_id) VALUES ($1, 'Create Skill', 'Skills', $2)",
      [req.user.id, result.rows[0].skill_id]
    );
    res.status(201).json({ message: "Skill created." });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// allows an admin to rename an existing skill
app.put("/api/skills/:id", isAdmin, async (req, res) => {
  try {
    await pool.query("UPDATE Skills SET skill_name = $1 WHERE skill_id = $2", [
      req.body.skillName,
      req.params.id,
    ]);
    await pool.query(
      "INSERT INTO Admin_Logs (admin_id, action_type, target_table, target_id) VALUES ($1, 'Update Skill', 'Skills', $2)",
      [req.user.id, req.params.id]
    );
    res.status(200).json({ message: "Skill updated." });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// allows an admin to delete a skill
app.delete("/api/skills/:id", isAdmin, async (req, res) => {
  try {
    await pool.query("DELETE FROM Skills WHERE skill_id = $1", [req.params.id]);
    await pool.query(
      "INSERT INTO Admin_Logs (admin_id, action_type, target_table, target_id) VALUES ($1, 'Delete Skill', 'Skills', $2)",
      [req.user.id, req.params.id]
    );
    res.status(200).json({ message: "Skill deleted." });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// searches for users or skills matching a query
app.get("/api/search", isAuthenticated, async (req, res) => {
  const q = req.query.q;
  if (!q || q.length < 2) return res.json({ results: [] });
  try {
    const result = await pool.query(
      `SELECT u.user_id, u.user_name, u.grade_level as sub_text, 'user' as type FROM Users u WHERE u.user_name ILIKE $1
             UNION ALL
             SELECT u.user_id, u.user_name, s.skill_name as sub_text, 'skill_match' as type FROM Users u JOIN User_Skills_Offered uso ON u.user_id = uso.user_id JOIN Skills s ON uso.skill_id = s.skill_id WHERE s.skill_name ILIKE $1 LIMIT 10`,
      [`%${q}%`]
    );
    res.json({ results: result.rows });
  } catch (e) {
    res.status(500).json({ message: "Error." });
  }
});

// starts the server on the specified port
app.listen(port, "0.0.0.0", () =>
  console.log(`Server is running on port ${port}`)
);


/* ==========================================================================
   FILE: package.json
   ========================================================================== */

{
  "name": "bpa_web_app",
  "version": "1.0.0",
  "description": "A brief description of what this project does and who it's for. Explain the core problem it solves or the main functionality it provides.",
  "scripts": {
    "start": "node index.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/Methusaleh/Web_App_Calkins.git"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "module",
  "bugs": {
    "url": "https://github.com/Methusaleh/Web_App_Calkins/issues"
  },
  "homepage": "https://github.com/Methusaleh/Web_App_Calkins#readme",
  "dependencies": {
    "bcryptjs": "^3.0.3",
    "body-parser": "^2.2.0",
    "connect-pg-simple": "^10.0.0",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "ejs": "^3.1.10",
    "express": "^5.1.0",
    "express-session": "^1.18.2",
    "morgan": "^1.10.1",
    "pg": "^8.16.3"
  }
}


/* ==========================================================================
   FILE: public\styles\main.css
   ========================================================================== */

/* =========================================
   1. VARIABLES & THEME CONFIGURATION
   ========================================= */
:root {
  /* New Vibrant Color Scheme */
  --primary-color: #2d4059; /* Deep Navy Blue */
  --primary-hover: #1f2d3f;
  --secondary-color: #ea5455; /* Bright Red/Coral */
  --accent-color: #f07b3f; /* Warm Orange */
  --highlight-color: #ffd460; /* Sunny Yellow */

  /* Additional States */
  --success-color: #10b981;
  --info-color: #3b82f6;
  --warning-color: #f07b3f;

  /* Colorful Neutral Scale */
  --bg-body: #ce6060; /* Darker orange background */
  --bg-card: #ffffff; /* White Cards */
  --bg-card-alt: #f0f9ff; /* Light blue alternative */
  --text-main: #1f2937; /* Dark Gray Text */
  --text-muted: #6b7280; /* Medium Gray Text */
  --border-color: #ffd46033; /* Soft yellow-tinted borders */

  /* Shadows with warm tones */
  --shadow-sm: 0 1px 2px 0 rgba(45, 64, 89, 0.1);
  --shadow-md: 0 4px 6px -1px rgba(45, 64, 89, 0.15),
    0 2px 4px -1px rgba(240, 123, 63, 0.1);
}

/* =========================================
   2. GLOBAL RESETS & LAYOUT
   ========================================= */
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #e8f4f8 0%, #f0f9ff 100%);
  background-attachment: fixed;
  color: var(--text-main);
  margin: 0;
  padding: 0;
  line-height: 1.6;
}

main {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
  margin-top: 20px;
}

h1,
h2,
h3 {
  color: var(--primary-color);
  margin-top: 0;
}

h1 {
  background: linear-gradient(135deg, var(--secondary-color), #2d4059);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

a {
  text-decoration: none;
  color: var(--primary-color);
  transition: color 0.2s;
}

a:hover {
  color: #ffd460;
}

button {
  cursor: pointer;
  background: linear-gradient(
    135deg,
    var(--secondary-color),
    var(--accent-color)
  );
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 600;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(234, 84, 85, 0.3);
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(234, 84, 85, 0.4);
}

button:active {
  transform: translateY(0);
}

/* Red Button -> Yellow Text on Hover (Instant, No Fade) */
.button-blue,
.btn-primary {
  background: #ea5455; /* Coral Red Background */
  color: white !important; /* White Text Default */
  border: none;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  text-decoration: none; /* vital since we are using <a> tags */
  display: inline-block; /* ensures padding works on links */
}

.button-blue:hover,
.btn-primary:hover {
  background: #ea5455; /* Background stays Red */
  color: #ffd460 !important; /* Text turns Sunny Yellow */
  box-shadow: 0 6px 12px rgba(234, 84, 85, 0.4);
  /* Note: No transition or transform property here */
}

/* Secondary button style */
button.secondary {
  background: linear-gradient(135deg, var(--primary-color), #3d5a7e);
}

button.secondary:hover {
  box-shadow: 0 4px 12px rgba(45, 64, 89, 0.4);
}

/* Accent button style */
button.accent {
  background: var(--highlight-color);
  color: var(--primary-color);
  box-shadow: 0 2px 8px rgba(255, 212, 96, 0.3);
}

button.accent:hover {
  box-shadow: 0 4px 12px rgba(255, 212, 96, 0.5);
}

input,
select,
textarea {
  display: block;
  width: 100%;
  max-width: 400px;
  margin-bottom: 15px;
  padding: 10px;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  font-size: 1em;
  transition: all 0.2s;
  background-color: white;
}

input:focus,
select:focus,
textarea:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 3px rgba(240, 123, 63, 0.15);
}

label {
  font-weight: bold;
  margin-top: 10px;
  display: block;
  color: var(--primary-color);
}

/* =========================================
   3. NAVBAR STYLING
   ========================================= */
.navbar {
  width: 100%;
  height: 60px;
  background: linear-gradient(90deg, var(--primary-color) 0%, #3d5a7e 100%);
  border-bottom: 3px solid var(--highlight-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  box-sizing: border-box;
  z-index: 1000;
  box-shadow: var(--shadow-md);
}

.nav-brand {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--highlight-color);
  display: flex;
  align-items: center;
  gap: 10px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.nav-links {
  display: flex;
  align-items: center;
  gap: 20px;
}

.nav-link {
  color: rgba(255, 255, 255, 0.9);
  font-weight: 600;
  padding: 8px 16px;
  border-radius: 8px;
  transition: all 0.2s;
}

.nav-link:hover {
  background-color: rgba(255, 212, 96, 0.2);
  color: var(--highlight-color);
  transform: translateY(-2px);
}

.nav-link.active {
  background: linear-gradient(
    135deg,
    var(--secondary-color),
    var(--accent-color)
  );
  color: white;
}

/* Profile Dropdown / Avatar Area */
.nav-user {
  display: flex;
  align-items: center;
  gap: 10px;
  padding-left: 20px;
  border-left: 2px solid rgba(255, 212, 96, 0.3);
}

.nav-avatar {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  border: 3px solid var(--highlight-color);
  box-shadow: 0 2px 8px rgba(255, 212, 96, 0.4);
}

/* =========================================
   4. TOAST NOTIFICATIONS
   ========================================= */
#toast-container {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.toast {
  min-width: 250px;
  padding: 15px 20px;
  border-radius: 8px;
  color: white;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  opacity: 0;
  transform: translateX(20px);
  transition: opacity 0.3s ease, transform 0.3s ease;
  display: flex;
  align-items: center;
}

.toast.show {
  opacity: 1;
  transform: translateX(0);
}

.toast-success {
  background: linear-gradient(135deg, #10b981, #059669);
  border-left: 5px solid #047857;
}

.toast-error {
  background: linear-gradient(135deg, var(--secondary-color), #d63031);
  border-left: 5px solid #c0392b;
}

.toast-info {
  background: linear-gradient(135deg, var(--primary-color), #3d5a7e);
  border-left: 5px solid #1f2d3f;
}

.toast-warning {
  background: linear-gradient(135deg, var(--accent-color), #e67e22);
  border-left: 5px solid #d35400;
}

/* =========================================
   5. COMPONENT FIXES
   ========================================= */
.radio-option {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  font-size: 1.1em;
  cursor: pointer;
  padding: 10px;
  border-radius: 8px;
  transition: all 0.2s;
}

.radio-option:hover {
  background-color: #fffbf5;
  border: 2px solid var(--highlight-color);
  margin-left: -2px;
}

.radio-option input[type="radio"] {
  margin-right: 10px;
  transform: scale(1.3);
  width: auto;
  display: inline-block;
  margin-bottom: 0;
  accent-color: var(--accent-color);
}


/* ==========================================================================
   FILE: seed.js
   ========================================================================== */

/* ==========================================================================
   FILE: seed.js
   Usage: node seed.js
   Description: Populates the DB with 20 users, skills, sessions, and ratings.
   ========================================================================== */

import pg from "pg";
import bcrypt from "bcryptjs";
import dotenv from "dotenv";

// Load environment variables (to get DATABASE_URL)
dotenv.config();

const { Pool } = pg;
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  // If you are using a cloud DB that requires SSL, uncomment the next line:
  // ssl: { rejectUnauthorized: false }
});

// --- CONFIGURATION ---
const USERS_TO_CREATE = 20;
const DEFAULT_PASSWORD = "password123"; // Simple password for all fake users

// --- DATA ARRAYS ---
const FIRST_NAMES = [
  "James",
  "Mary",
  "Robert",
  "Patricia",
  "John",
  "Jennifer",
  "Michael",
  "Linda",
  "David",
  "Elizabeth",
  "William",
  "Barbara",
  "Richard",
  "Susan",
  "Joseph",
  "Jessica",
  "Thomas",
  "Sarah",
  "Charles",
  "Karen",
  "Daniel",
  "Lisa",
  "Matthew",
];

const LAST_NAMES = [
  "Smith",
  "Johnson",
  "Williams",
  "Brown",
  "Jones",
  "Garcia",
  "Miller",
  "Davis",
  "Rodriguez",
  "Martinez",
  "Hernandez",
  "Lopez",
  "Gonzalez",
  "Wilson",
  "Anderson",
  "Thomas",
  "Taylor",
  "Moore",
  "Jackson",
  "Martin",
  "Lee",
  "Perez",
];

const SCHOOLS = [
  "Francis Tuttle Tech",
  "Piedmont High",
  "Oklahoma City Univ",
  "Tulsa Community College",
  "Norman North High",
  "Edmond Santa Fe",
];

const SKILL_LIST = [
  "Algebra",
  "Calculus",
  "Python Programming",
  "Creative Writing",
  "Public Speaking",
  "Guitar",
  "Piano",
  "Spanish",
  "French",
  "Biology",
  "Chemistry",
  "History",
  "Graphic Design",
  "Video Editing",
];

const FEEDBACK_COMMENTS = [
  "Great teacher! Very patient.",
  "Explained the concepts clearly.",
  "A bit fast, but knows their stuff.",
  "Helped me ace my test!",
  "Would definitely recommend.",
  "Super friendly and helpful.",
  "Thanks for the help!",
  "Good session, solved my problem.",
];

const AVATAR_STYLES = ["bottts", "avataaars", "micah", "identicon"];

// --- HELPER FUNCTIONS ---
function getRandom(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function getRandomDate(start, end) {
  return new Date(
    start.getTime() + Math.random() * (end.getTime() - start.getTime())
  );
}

// --- MAIN FUNCTION ---
async function seedDatabase() {
  console.log(" Starting Database Seed...");

  try {
    // 1. Ensure Skills Exist
    console.log(" Seeding Master Skills...");
    for (const skill of SKILL_LIST) {
      await pool.query(
        `INSERT INTO Skills (skill_name) VALUES ($1) ON CONFLICT (skill_name) DO NOTHING`,
        [skill]
      );
    }

    // Get all skill IDs for later assignment
    const skillsRes = await pool.query("SELECT * FROM Skills");
    const allSkills = skillsRes.rows;

    // 2. Create Users
    console.log(` Creating ${USERS_TO_CREATE} Fake Users...`);
    const hashedPassword = await bcrypt.hash(DEFAULT_PASSWORD, 10);
    const createdUsers = [];

    for (let i = 0; i < USERS_TO_CREATE; i++) {
      const fname = getRandom(FIRST_NAMES);
      const lname = getRandom(LAST_NAMES);
      const email = `${fname.toLowerCase()}.${lname.toLowerCase()}${Math.floor(
        Math.random() * 1000
      )}@example.com`;

      // Randomly assign school and grade
      const school = Math.random() > 0.3 ? getRandom(SCHOOLS) : null;
      const grade = Math.random() > 0.5 ? "12th" : "College";

      const res = await pool.query(
        `INSERT INTO Users (email, password_hash, user_name, date_of_birth, grade_level, school_college, is_admin, avatar_style) 
                 VALUES ($1, $2, $3, $4, $5, $6, FALSE, $7) 
                 ON CONFLICT (email) DO NOTHING
                 RETURNING user_id, user_name`,
        [
          email,
          hashedPassword,
          `${fname} ${lname}`,
          getRandomDate(new Date(2000, 0, 1), new Date(2008, 0, 1)),
          grade,
          school,
          getRandom(AVATAR_STYLES),
        ]
      );

      if (res.rows.length > 0) {
        createdUsers.push(res.rows[0]);
      }
    }

    if (createdUsers.length === 0) {
      console.log(
        " No new users created (maybe emails already existed?). fetching existing ones..."
      );
      const existing = await pool.query(
        "SELECT user_id, user_name FROM Users LIMIT 20"
      );
      createdUsers.push(...existing.rows);
    }

    // 3. Assign Skills (Offer & Seek)
    console.log(" Assigning Skills...");
    for (const user of createdUsers) {
      // Assign 1-3 Offered Skills
      const numOffers = Math.floor(Math.random() * 3) + 1;
      for (let j = 0; j < numOffers; j++) {
        const skill = getRandom(allSkills);
        await pool.query(
          `INSERT INTO User_Skills_Offered (user_id, skill_id, is_virtual_only, is_inperson_only) 
                     VALUES ($1, $2, $3, $4) ON CONFLICT DO NOTHING`,
          [
            user.user_id,
            skill.skill_id,
            Math.random() > 0.5,
            Math.random() > 0.5,
          ]
        );
      }

      // Assign 1-3 Sought Skills
      const numSeeks = Math.floor(Math.random() * 3) + 1;
      for (let k = 0; k < numSeeks; k++) {
        const skill = getRandom(allSkills);
        // Don't seek what you offer (mostly)
        await pool.query(
          `INSERT INTO User_Skills_Sought (user_id, skill_id, is_virtual_only, is_inperson_only) 
                     VALUES ($1, $2, $3, $4) ON CONFLICT DO NOTHING`,
          [
            user.user_id,
            skill.skill_id,
            Math.random() > 0.5,
            Math.random() > 0.5,
          ]
        );
      }
    }

    // 4. Create History (Sessions & Ratings)
    console.log(" Generating Session History & Ratings...");

    // We will create ~15 random completed sessions
    for (let i = 0; i < 15; i++) {
      const provider = getRandom(createdUsers);
      let requester = getRandom(createdUsers);

      // Ensure provider != requester
      while (requester.user_id === provider.user_id) {
        requester = getRandom(createdUsers);
      }

      const skill = getRandom(allSkills); // Ideally check if provider actually offers this, but for seed it's okay
      const sessionDate = getRandomDate(new Date(2025, 0, 1), new Date());

      // Create Session
      const sessRes = await pool.query(
        `INSERT INTO Sessions (provider_id, requester_id, skill_taught_id, session_date_time, location_type, status)
                 VALUES ($1, $2, $3, $4, 'Online', 'Completed') RETURNING session_id`,
        [provider.user_id, requester.user_id, skill.skill_id, sessionDate]
      );

      const sessionId = sessRes.rows[0].session_id;

      // Add Rating (80% chance of "Like")
      const liked = Math.random() > 0.2;
      const comment = liked
        ? getRandom(FEEDBACK_COMMENTS)
        : "Provider was late.";

      await pool.query(
        `INSERT INTO Ratings (session_id, rater_id, ratee_id, like_status, feedback_text)
                 VALUES ($1, $2, $3, $4, $5)`,
        [sessionId, requester.user_id, provider.user_id, liked, comment]
      );
    }

    console.log(" Seed Complete!");
    console.log(` Added/Verified ${createdUsers.length} users.`);
    console.log(` All new users have password: '${DEFAULT_PASSWORD}'`);
    process.exit(0);
  } catch (error) {
    console.error(" Seed Failed:", error);
    process.exit(1);
  }
}

seedDatabase();


/* ==========================================================================
   FILE: views\about.ejs
   ========================================================================== */

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>About - SkillSwap</title>
    <link rel="stylesheet" href="/styles/main.css" />
    <style>
      .about-section {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
        border: 1px solid #eee;
      }
      .tech-tag {
        display: inline-block;
        background: #f0f9ff;
        color: #0284c7;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.9em;
        font-weight: bold;
        margin: 0 5px 5px 0;
        border: 1px solid #bae6fd;
      }
    </style>
  </head>
  <body
    style="
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background-color: #f9fafb;
    "
  >
    <%- include('partials/navbar') %>

    <main>
      <div style="text-align: center; margin-bottom: 40px">
        <h1 style="font-size: 2.5em; margin-bottom: 10px">About SkillSwap</h1>
        <p style="color: #666; font-size: 1.2em">
          Connecting students who want to learn together.
        </p>
      </div>

      <div class="about-section">
        <h2>Our Mission</h2>
        <p>
          "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
          eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad
          minim veniam, quis nostrud exercitation ullamco laboris nisi ut
          aliquip ex ea commodo consequat. Duis aute irure dolor in
          reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla
          pariatur. Excepteur sint occaecat cupidatat non proident, sunt in
          culpa qui officia deserunt mollit anim id est laborum."
        </p>
      </div>

      <div class="about-section">
        <h2>Technical Specifications</h2>
        <p style="margin-bottom: 15px">
          This application was built from scratch using modern web development
          technologies:
        </p>
        <div>
          <span class="tech-tag">Node.js</span>
          <span class="tech-tag">Express.js</span>
          <span class="tech-tag">PostgreSQL</span>
          <span class="tech-tag">EJS Templating</span>
          <span class="tech-tag">CSS3 Variables</span>
          <span class="tech-tag">Axios (Async API)</span>
          <span class="tech-tag">Bcrypt Hashing</span>
        </div>
        <p style="margin-top: 15px; font-size: 0.9em; color: #555">
          <strong>Security Features:</strong> Secure session management,
          password hashing, SQL injection protection, and role-based access
          control for Administrators.
        </p>
      </div>

      <div class="about-section">
        <h2>The Development Team</h2>
        <p>
          <strong>Francis Tuttle Institute of Technology (Reno Chapter)</strong
          ><br />
          Business Professionals of America - Web Application Team (2026)
        </p>
        <ul style="margin-top: 10px; color: #333">
          <li>Aaron Kipf</li>
          <li>Austin Coco</li>
          <li>Michael Crawford</li>
          <li>Zach All</li>
        </ul>
      </div>
    </main>

    <%- include('partials/footer') %>
  </body>
</html>


/* ==========================================================================
   FILE: views\admin_dashboard.ejs
   ========================================================================== */

<!DOCTYPE html>
<html>
<head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css">
    <style>
        .admin-section { margin-bottom: 40px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #eaeaea; }
        .btn-small { padding: 4px 8px; font-size: 0.8em; cursor: pointer; border-radius: 4px; border: none; color: white; }
        .btn-danger { background-color: #ef4444; }
        .btn-success { background-color: #10b981; }
        .btn-promote { background-color: #3b82f6; } /* Blue */
        .btn-demote { background-color: #f59e0b; } /* Amber */
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <%- include('partials/navbar') %>

    <main>
        <div style="margin-bottom: 20px;">
            <a href="/" style="text-decoration: none; color: #333; font-weight: bold;">&larr; Back to Main Dashboard</a>
        </div>

        <h1>Admin Control Panel</h1>
        <p>Monitor activity, manage users, and curate skills.</p>

        <section class="admin-section" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;"> System Activity Log</h2>
                <button onclick="fetchLogs()" style="padding: 5px 10px; font-size: 0.9em; cursor: pointer;">Refresh Logs</button>
            </div>
            
            <div style="max-height: 250px; overflow-y: auto; border: 1px solid #eee;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead style="background: #f8f9fa; position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Time</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Admin User</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Action</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Target</th>
                        </tr>
                    </thead>
                    <tbody id="logsBody">
                        <tr><td colspan="4" style="padding: 20px; text-align: center;">Loading activity...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        <div class="admin-section">
            <h2>1. Pending Skill Suggestions</h2>
            <p>Review skills suggested by users.</p>
            <table id="suggestionsTable">
                <thead>
                    <tr>
                        <th>Suggested Skill</th>
                        <th>Suggested By</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="suggestionsBody"><tr><td colspan="4">Loading...</td></tr></tbody>
            </table>
        </div>

        <div class="admin-section">
            <h2>2. Security Reports</h2>
            <p>Monitor user reports and update their status.</p>
            <table id="reportsTable">
                <thead>
                    <tr>
                        <th>Reported User</th>
                        <th>Reason</th>
                        <th>Reporter</th>
                        <th>Current Status</th>
                        <th>Update Status</th>
                    </tr>
                </thead>
                <tbody id="reportsBody"><tr><td colspan="5">Loading...</td></tr></tbody>
            </table>
        </div>

        <div class="admin-section">
            <h2>3. User Database</h2>
            <p>View all registered users and remove accounts if necessary.</p>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Grade</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersBody"><tr><td colspan="5">Loading...</td></tr></tbody>
            </table>
        </div>
        
        <div class="admin-section">
            <h2>4. Add Master Skill Manually</h2>
            <form id="addSkillForm" style="display:flex; gap:10px;">
                <input type="text" id="newMasterSkill" placeholder="New Skill Name" required style="flex-grow:1; margin-bottom: 0;">
                <button type="submit">Add Skill</button>
            </form>
        </div>

    </main>
    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // helper function to show toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // load all data tables when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchSuggestions();
            fetchReports();
            fetchUsers();
            fetchLogs();
        });

        // fetches pending skill suggestions from the api
        async function fetchSuggestions() {
            const tbody = document.getElementById('suggestionsBody');
            try {
                const res = await axios.get('/api/admin/suggestions');
                const data = res.data.suggestions;
                tbody.innerHTML = '';
                if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="4">No pending suggestions.</td></tr>'; return; }
                data.forEach(item => {
                    const row = `<tr>
                        <td>${item.suggested_skill_name}</td>
                        <td>${item.suggesting_user || 'Unknown'}</td>
                        <td>${new Date(item.timestamp).toLocaleDateString()}</td>
                        <td>
                            <button class="btn-small btn-success" onclick="processSuggestion(${item.suggestion_id}, 'approve')">Approve</button>
                            <button class="btn-small btn-danger" onclick="processSuggestion(${item.suggestion_id}, 'reject')">Reject</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) { tbody.innerHTML = '<tr><td colspan="4">Error loading data.</td></tr>'; }
        }

        // sends approval or rejection for a skill suggestion
        async function processSuggestion(id, action) {
            try {
                await axios.post('/api/admin/suggestions/action', { suggestionId: id, action: action });
                showToast("Suggestion processed.", "success");
                fetchSuggestions();
            } catch (err) { showToast('Error processing suggestion.', "error"); }
        }

        // fetches all security reports from the api
        async function fetchReports() {
            const tbody = document.getElementById('reportsBody');
            try {
                const res = await axios.get('/api/admin/reports');
                const data = res.data.reports;
                tbody.innerHTML = '';
                if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5">No active reports.</td></tr>'; return; }
                data.forEach(item => {
                    const row = `<tr>
                        <td><strong>${item.reported_user_name}</strong> (ID: ${item.reported_user_id})</td>
                        <td>${item.report_reason}</td>
                        <td>${item.reporter_name}</td>
                        <td style="font-weight:bold;">${item.report_status}</td>
                        <td>
                            <select onchange="updateReportStatus(${item.report_id}, this.value)" style="margin-bottom:0;">
                                <option value="">-- Change Status --</option>
                                <option value="Under Review">Under Review</option>
                                <option value="Action Taken">Action Taken</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) { tbody.innerHTML = '<tr><td colspan="5">Error loading reports.</td></tr>'; }
        }

        // updates the status of a specific security report
        async function updateReportStatus(id, newStatus) {
            if(!newStatus) return;
            try {
                await axios.post(`/api/admin/report/${id}/status`, { newStatus: newStatus });
                showToast("Report status updated.", "success");
                fetchReports();
            } catch (err) { showToast('Error updating status.', "error"); }
        }

        // fetches the list of all users from the api
        async function fetchUsers() {
            const tbody = document.getElementById('usersBody');
            try {
                const res = await axios.get('/api/admin/users');
                const data = res.data.users;
                tbody.innerHTML = '';
                data.forEach(u => {
                    let actions = '';
                    const isRootAdmin = (u.user_id === 1);
                    const isMe = (u.user_id == '<%= user.id %>');

                    // visual protection for root admin and current user
                    if (isRootAdmin) {
                        actions = '<span style="color:#d97706; font-weight:bold; border:1px solid #d97706; padding:2px 6px; border-radius:4px;">ROOT ADMIN</span>';
                    } else if (isMe) {
                        actions = '<span style="color:#888; font-style:italic;">Current User</span>';
                    } else {
                        const roleBtn = u.is_admin 
                            ? `<button class="btn-small btn-demote" style="margin-right:5px;" onclick="toggleAdmin(${u.user_id})">Demote</button>`
                            : `<button class="btn-small btn-promote" style="margin-right:5px;" onclick="toggleAdmin(${u.user_id})">Make Admin</button>`;
                        const deleteBtn = `<button class="btn-small btn-danger" onclick="deleteUser(${u.user_id})">Delete</button>`;
                        actions = `${roleBtn} ${deleteBtn}`;
                    }

                    const row = `<tr>
                        <td>${u.user_id}</td>
                        <td>${u.user_name} ${u.is_admin ? '<strong>(Admin)</strong>' : ''}</td>
                        <td>${u.email}</td>
                        <td>${u.grade_level || '-'}</td>
                        <td>${actions}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) { tbody.innerHTML = '<tr><td colspan="5">Error loading users.</td></tr>'; }
        }

        // promotes or demotes a user's admin status
        async function toggleAdmin(id) {
            if(!confirm(`Change Admin status for User ID ${id}?`)) return;
            try {
                const res = await axios.post(`/api/admin/users/${id}/toggle_role`);
                showToast(res.data.message, "success");
                fetchUsers();
            } catch (err) { showToast(err.response?.data?.message || 'Error updating role.', "error"); }
        }

        // permanently deletes a user account
        async function deleteUser(id) {
            if(!confirm(`Permanently DELETE User ID ${id}? This cannot be undone.`)) return;
            try {
                await axios.delete(`/api/admin/users/${id}`);
                showToast("User deleted successfully.", "success");
                fetchUsers();
            } catch (err) { showToast('Error deleting user.', "error"); }
        }

        // handles manual skill addition by the admin
        document.getElementById('addSkillForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newMasterSkill').value;
            try {
                await axios.post('/api/skills', { skillName: name });
                showToast('Skill added to master list!', "success");
                document.getElementById('newMasterSkill').value = '';
            } catch (err) { showToast('Error adding skill (it may already exist).', "error"); }
        });

        // function to fetch and display audit logs
        async function fetchLogs() {
            const tbody = document.getElementById('logsBody');
            
            try {
                const res = await axios.get('/api/admin/logs');
                const logs = res.data.logs;

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center;">No activity recorded yet.</td></tr>';
                    return;
                }

                tbody.innerHTML = ''; // clear loading message

                logs.forEach(log => {
                    // format date (e.g., "12/9/2025, 1:53 PM")
                    const dateStr = new Date(log.timestamp).toLocaleString();
                    
                    const row = `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px; color: #666;">${dateStr}</td>
                            <td style="padding: 8px; font-weight: bold;">${log.user_name}</td>
                            <td style="padding: 8px;">
                                <span style="background: #e3f2fd; color: #0d47a1; padding: 2px 6px; border-radius: 4px; font-size: 0.85em;">
                                    ${log.action_type}
                                </span>
                            </td>
                            <td style="padding: 8px; color: #555;">${log.target_table}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: red;">Error loading logs.</td></tr>';
            }
        }
    </script>
</body>
</html>

/* ==========================================================================
   FILE: views\chat.ejs
   ========================================================================== */

<!DOCTYPE html>
<html>
<head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css">
    <style>
        /* styles for the chat interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 70vh; /* takes up 70% of screen height */
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #fff;
            overflow: hidden;
        }

        /* area where messages scroll */
        .chat-window {
            flex: 1;
            overflow-y: auto; /* allows scrolling */
            padding: 20px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 1rem;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }

        /* styles for messages sent by the current user */
        .msg-sent {
            align-self: flex-end;
            background-color: #dcfce7; /* light green */
            color: #14532d;
            border-bottom-right-radius: 2px;
        }

        /* styles for messages received from the other user */
        .msg-received {
            align-self: flex-start;
            background-color: #e5e7eb; /* light gray */
            color: #1f2937;
            border-bottom-left-radius: 2px;
        }

        .timestamp {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 5px;
            display: block;
            text-align: right;
        }

        /* input area at the bottom */
        .chat-input-area {
            padding: 15px;
            background: #fff;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        .chat-input-area input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <%- include('partials/navbar') %>
    
    <main>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <div style="display: flex; gap: 15px;">
                <a href="/messages" style="text-decoration: none; color: #333; font-weight: bold;">
                    &larr; Back to Inbox
                </a>
                <span style="color: #ccc;">|</span>
                <a href="/" style="text-decoration: none; color: #333; font-weight: bold;">
                     Dashboard
                </a>
            </div>
            
            <a href="/profile/view/<%= otherUser.id %>" style="font-size: 0.9em; color: #2563eb; text-decoration: none;">
                View <%= otherUser.name %>'s Profile &rarr;
            </a>
        </div>

        <h1>Chat with <%= otherUser.name %></h1>

        <div class="chat-container">
            <div id="chatWindow" class="chat-window">
                <p style="text-align:center; color:#888;">Loading conversation...</p>
            </div>

            <form id="chatForm" class="chat-input-area">
                <input type="text" id="messageText" placeholder="Type a message..." required autocomplete="off">
                <button type="submit" style="margin-bottom:0;">Send</button>
            </form>
        </div>

    </main>
    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const otherUserId = '<%= otherUser.id %>';
        const myUserId = '<%= user.id %>';
        let isFirstLoad = true;

        // helper function to show toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            // trigger animation
            requestAnimationFrame(() => toast.classList.add('show'));
            
            // remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // fetches conversation history from the backend
        async function fetchMessages() {
            try {
                const response = await axios.get(`/api/messages/thread/${otherUserId}`);
                const messages = response.data.messages;
                const chatWindow = document.getElementById('chatWindow');

                // display message if chat is empty
                if (messages.length === 0) {
                    chatWindow.innerHTML = '<p style="text-align:center; color:#ccc; margin-top:20px;">No messages yet. Say hello!</p>';
                    return;
                }

                // renders each message bubble
                chatWindow.innerHTML = messages.map(msg => {
                    // determine if the message was sent or received
                    const isMe = (String(msg.sender_id) === String(myUserId));
                    const type = isMe ? 'msg-sent' : 'msg-received';
                    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    // generate avatar image based on user style
                    const style = msg.sender_avatar_style || 'bottts';
                    const avatarUrl = `https://api.dicebear.com/7.x/${style}/svg?seed=${msg.sender_name}`;
                    const avatarImg = `<img src="${avatarUrl}" style="width: 30px; height: 30px; border-radius: 50%; margin: 0 10px; align-self: flex-end;">`;

                    return `
                        <div style="display:flex; margin-bottom: 10px; justify-content: ${isMe ? 'flex-end' : 'flex-start'};">
                            ${!isMe ? avatarImg : ''}
                            <div class="message-bubble ${type}">
                                ${msg.message_text}
                                <span class="timestamp">${time}</span>
                            </div>
                            ${isMe ? avatarImg : ''}
                        </div>
                    `;
                }).join('');

                // auto-scroll to the bottom only on the first load
                if (isFirstLoad) {
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                    isFirstLoad = false;
                }

            } catch (error) {
                console.error("Error fetching chat:", error);
            }
        }

        // handles sending a new message
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('messageText');
            const text = input.value;
            
            if (!text.trim()) return;

            try {
                // posts the message to the api
                await axios.post('/api/messages/send', {
                    receiverId: otherUserId,
                    messageText: text
                });
                
                input.value = ''; // clear input field
                fetchMessages();  // refresh chat immediately
                
                // force scroll to bottom
                const chatWindow = document.getElementById('chatWindow');
                setTimeout(() => chatWindow.scrollTop = chatWindow.scrollHeight, 100);

            } catch (error) {
                showToast("Failed to send message.", "error");
            }
        });

        // load messages immediately
        fetchMessages();
        
        // polls for new messages every 3 seconds
        setInterval(fetchMessages, 3000);

    </script>
</body>
</html>

/* ==========================================================================
   FILE: views\forgot_password.ejs
   ========================================================================== */

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - SkillSwap</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh; background-color: #f9fafb;">
    
    <%- include('partials/navbar') %>

    <main style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px;">
            <h2 style="margin-top: 0; text-align: center; color: #333;">Reset Password</h2>
            <p style="color: #666; text-align: center; margin-bottom: 25px;">Enter your email to receive a reset link.</p>
            
            <form action="/forgot-password" method="POST">
                <input type="email" name="email" placeholder="Enter your email" required 
                       style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                
                <button type="submit" class="btn-primary" 
                        style="width: 100%; padding: 12px; background: #EA5455; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                    Send Reset Link
                </button>
            </form>
            
            <div style="margin-top: 20px; text-align: center;">
                <a href="/login" style="color: #666; font-size: 0.9em; text-decoration: none;">Back to Login</a>
            </div>
        </div>
    </main>

    <%- include('partials/footer') %>
</body>
</html>


/* ==========================================================================
   FILE: views\forgot_password_sent.ejs
   ========================================================================== */

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Your Email - SkillSwap</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh; background-color: #f9fafb;">

    <%- include('partials/navbar') %>

    <main style="flex: 1; padding: 40px 20px; max-width: 600px; margin: 0 auto; text-align: center;">
        
        <h1 style="color: #1f2937; margin-bottom: 10px;">Check your Email</h1>
        <p style="color: #6b7280; font-size: 1.1em; margin-bottom: 40px;">
            If an account exists for <strong><%= email %></strong>, we have sent a reset link.
        </p>

        <% if (token) { %>
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; text-align: left;">
            
            <div style="background: #f0f9ff; padding: 15px; border-bottom: 1px solid #bfdbfe; display: flex; align-items: center; justify-content: space-between;">
                <span style="font-weight: bold; color: #1e40af; font-size: 0.9em; display: flex; align-items: center; gap: 6px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    Demo Mode
                </span>
                <span style="font-size: 0.85em; color: #60a5fa;">Email Preview</span>
            </div>

            <div style="padding: 30px;">
                <p style="font-size: 0.95em; color: #4b5563; margin-bottom: 20px; text-align: center;">
                    Here is the mock email for you:
                </p>
                
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 15px; border-bottom: 1px solid #e5e7eb; font-size: 0.9em;">
                        <div style="margin-bottom: 5px;"><strong>From:</strong> <span style="color: #4b5563;">support@skillswap.app</span></div>
                        <div><strong>Subject:</strong> <span style="color: #111;">Reset your password</span></div>
                    </div>
                    
                    <div style="padding: 25px; background: white;">
                        <p style="margin-bottom: 20px; color: #374151;">Click below to reset your password:</p>
                        
                        <a href="/reset-password/<%= token %>" 
                           style="display: inline-block; background: #2563eb; color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 0.95em;">
                            Reset Password Now &rarr;
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <% } %>

    </main>

    <%- include('partials/footer') %>
</body>
</html>

/* ==========================================================================
   FILE: views\inbox.ejs
   ========================================================================== */

<!DOCTYPE html>
<html>
<head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css">
    <style>
        /* styles for the list of conversations */
        .inbox-list { list-style: none; padding: 0; }
        
        /* individual conversation row styling */
        .inbox-item { 
            display: flex; justify-content: space-between; align-items: center;
            background: white; border: 1px solid #eee; 
            padding: 15px; margin-bottom: 10px; border-radius: 6px;
            text-decoration: none; color: inherit; transition: background 0.2s;
        }
        .inbox-item:hover { background: #f9fafb; border-color: #ccc; }
        
        /* styling for names and message previews */
        .inbox-name { font-weight: bold; font-size: 1.1em; color: #ea5455cc; }
        .inbox-preview { color: #666; font-size: 0.9em; margin-top: 5px; }
        .inbox-time { font-size: 0.8em; color: #999; white-space: nowrap; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <%- include('partials/navbar') %>

    <main>
        <div style="margin-bottom: 20px;">
            <a href="/" style="text-decoration: none; color: #333; font-weight: bold;">&larr; Back to Dashboard</a>
        </div>

        <h1>My Inbox</h1>
        <p id="loadingMsg">Loading conversations...</p>
        <ul id="inboxList" class="inbox-list"></ul>
    </main>
    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // helper function to show toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            // triggers the slide in animation
            requestAnimationFrame(() => toast.classList.add('show'));
            
            // removes the toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // load conversations when the page finishes loading
        document.addEventListener('DOMContentLoaded', async () => {
            const list = document.getElementById('inboxList');
            const loading = document.getElementById('loadingMsg');

            try {
                // fetch the list of active conversations from the api
                const response = await axios.get('/api/messages/inbox');
                const conversations = response.data.conversations;

                // hide the loading text once data is received
                loading.style.display = 'none';

                // show a message if the inbox is empty
                if (conversations.length === 0) {
                    list.innerHTML = '<p>No messages yet.</p>';
                    return;
                }

                // loop through each conversation and create a list item
                conversations.forEach(convo => {
                    const time = new Date(convo.timestamp).toLocaleDateString() + ' ' + new Date(convo.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // build the html for the conversation row
                    const item = `
                        <a href="/messages/${convo.other_user_id}" class="inbox-item">
                            <div>
                                <div class="inbox-name">${convo.other_user_name}</div>
                                <div class="inbox-preview">${convo.message_text.substring(0, 50)}...</div>
                            </div>
                            <div class="inbox-time">${time}</div>
                        </a>
                    `;
                    list.innerHTML += item;
                });

            } catch (error) {
                console.error(error);
                loading.textContent = 'Error loading messages.';
                showToast("Failed to load inbox.", "error");
            }
        });
    </script>
</body>
</html>


/* ==========================================================================
   FILE: views\index.ejs
   ========================================================================== */

<!DOCTYPE html>
<html>
  <head>
    <title>SkillSwap - <%= user ? 'Dashboard' : 'Login' %></title>
    <link rel="stylesheet" href="/styles/main.css" />
  </head>
  <body>
    <div id="toast-container"></div>

    <%- include('partials/navbar') %>

    <main>
      <% if (user) { %>

      <div style="margin-bottom: 30px; position: relative">
        <h3> Find & Swap Skills</h3>
        <input
          type="text"
          id="searchInput"
          placeholder="Search by Name or Skill..."
          style="
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 6px;
          "
        />

        <div
          id="searchResults"
          style="
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
          "
        ></div>
      </div>

      <div
        style="
          background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
          padding: 30px;
          border-radius: 8px;
          border: 1px solid #bae6fd;
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 40px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        "
      >
        <div>
          <h2 style="margin: 0 0 10px 0; color: #0c4a6e">
            Ready to learn something new?
          </h2>
          <p style="margin: 0; color: #0284c7">
            Book a session in less than a minute.
          </p>
        </div>
        <a
          href="/session/request"
          class="btn-primary"
          style="
            text-decoration: none;
            padding: 12px 25px;
            white-space: nowrap;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          "
        >
           Schedule Session &rarr;
        </a>
      </div>

      <% if (typeof topTeachers !== 'undefined' && topTeachers.length > 0) { %>
      <div style="margin-top: 40px">
        <h2> Top Rated Teachers</h2>
        <p style="color: #666; margin-bottom: 15px">
          Community favorites based on student feedback.
        </p>

        <div style="display: flex; gap: 15px; flex-wrap: wrap">
          <% topTeachers.forEach(teacher => { %>
          <div
            style="
              border: 1px solid #eee;
              padding: 20px;
              border-radius: 8px;
              background: white;
              width: 200px;
              text-align: center;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
              transition: transform 0.2s;
            "
          >
            <img
              src="https://api.dicebear.com/7.x/<%= teacher.avatar_style || 'bottts' %>/svg?seed=<%= teacher.user_name %>"
              alt="Teacher Avatar"
              style="
                width: 60px;
                height: 60px;
                border-radius: 50%;
                margin-bottom: 10px;
                background-color: #f3f4f6;
              "
            />

            <div style="font-weight: bold; color: #333; font-size: 1.1em">
              <%= teacher.user_name %>
            </div>

            <div
              style="
                color: #059669;
                font-size: 0.9em;
                margin-top: 5px;
                font-weight: bold;
              "
            >
               <%= teacher.like_count %> Likes
            </div>

            <a
              href="/profile/view/<%= teacher.user_id %>"
              style="
                display: inline-block;
                margin-top: 15px;
                padding: 5px 10px;
                background-color: #eff6ff;
                color: #2563eb;
                border-radius: 4px;
                text-decoration: none;
                font-size: 0.85em;
                font-weight: bold;
              "
              >View Profile</a
            >
          </div>
          <% }) %>
        </div>
      </div>
      <% } %> <% } else { %>

      <div
        style="
          max-width: 400px;
          margin: 50px auto;
          padding: 30px;
          border: 1px solid #ddd;
          border-radius: 8px;
          background: white;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        "
      >
        <h1 style="text-align: center; color: var(--primary-color)">
          SkillSwap
        </h1>
        <h2
          style="
            text-align: center;
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
          "
        >
          Log In
        </h2>

        <form id="loginForm">
          <input type="email" id="email" placeholder="Email" required />
          <input
            type="password"
            id="password"
            placeholder="Password"
            required
          />

          <div style="text-align: right; margin-bottom: 15px">
            <a
              href="/forgot-password"
              style="font-size: 0.9em; color: #2563eb; text-decoration: none"
            >
              Forgot Password?
            </a>
          </div>
          <button type="submit" style="width: 100%">Log In</button>
        </form>

        <p
          id="messageArea"
          style="color: red; margin-top: 10px; text-align: center"
        ></p>

        <hr style="margin: 20px 0" />

        <p style="text-align: center">
          New Student?
          <a href="/register" style="font-weight: bold">Create an Account</a>
        </p>
      </div>

      <% } %>
    </main>

    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      // client-side javascript logic
      const messageArea = document.getElementById("messageArea");

      // logic runs only if the login form exists which means the user is not logged in
      if (document.getElementById("loginForm")) {
        document
          .getElementById("loginForm")
          .addEventListener("submit", handleLoginSubmit);
      }

      async function handleLoginSubmit(event) {
        event.preventDefault();

        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        messageArea.textContent = "";

        try {
          // axios post request to the express api
          const response = await axios.post("/api/login", {
            email: email,
            password: password,
          });

          if (response.status === 200) {
            messageArea.textContent = "Login Successful! Redirecting...";
            messageArea.style.color = "green";

            // on success reload the page to load the authenticated dashboard view
            window.location.href = "/";
          }
        } catch (error) {
          let errorMessage = "An unexpected error occurred.";
          if (error.response) {
            errorMessage = error.response.data.message || errorMessage;
          }

          messageArea.textContent = errorMessage;
          messageArea.style.color = "red";
          console.error("Login Failed:", errorMessage);
        }
      }

      // search bar logic which only runs if the search input exists
      const searchInput = document.getElementById("searchInput");
      const resultsBox = document.getElementById("searchResults");

      if (searchInput) {
        let timeout = null;

        searchInput.addEventListener("input", (e) => {
          // debounce clears the previous timer so we do not spam the server
          clearTimeout(timeout);
          const query = e.target.value.trim();

          if (query.length < 2) {
            resultsBox.style.display = "none";
            return;
          }

          // waits 300ms after the user stops typing to send the request
          timeout = setTimeout(async () => {
            try {
              const response = await axios.get(
                `/api/search?q=${encodeURIComponent(query)}`
              );
              const results = response.data.results;
              resultsBox.innerHTML = "";

              if (results.length === 0) {
                resultsBox.innerHTML =
                  '<div style="padding:15px; color:#666;">No results found.</div>';
              } else {
                results.forEach((item) => {
                  const subText =
                    item.type === "skill_match"
                      ? `Teaches: <strong>${item.sub_text}</strong>`
                      : `Grade: ${item.sub_text || "N/A"}`;

                  const div = document.createElement("div");
                  div.style.padding = "10px 15px";
                  div.style.borderBottom = "1px solid #eee";
                  div.style.cursor = "pointer";
                  div.innerHTML = `
                                    <div style="font-weight:bold; color:#2563eb;">${item.user_name}</div>
                                    <div style="font-size:0.85em; color:#555;">${subText}</div>
                                `;
                  div.onclick = () =>
                    (window.location.href = `/profile/view/${item.user_id}`);
                  div.onmouseover = () => (div.style.background = "#f9fafb");
                  div.onmouseout = () => (div.style.background = "white");

                  resultsBox.appendChild(div);
                });
              }
              resultsBox.style.display = "block";
            } catch (err) {
              console.error("Search failed", err);
            }
          }, 300);
        });

        // hides the dropdown if the user clicks anywhere else on the page
        document.addEventListener("click", (e) => {
          if (
            !searchInput.contains(e.target) &&
            !resultsBox.contains(e.target)
          ) {
            resultsBox.style.display = "none";
          }
        });
      }
    </script>
  </body>
</html>


/* ==========================================================================
   FILE: views\landing.ejs
   ========================================================================== */

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to SkillSwap</title>
    <link rel="stylesheet" href="/styles/main.css">
    
    <style>
        /* Forces the body to be WHITE behind everything */
        /* This hides the gray gap by making it blend with the footer */
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: white !important; 
        }

        /* High contrast override (keeps your existing behavior) */
        body.high-contrast-mode nav,
        body.high-contrast-mode .navbar {
            background: #000 !important;
            border-bottom: 2px solid yellow;
        }

        /* Navbar: reduced height and persistent 2px yellow bottom border */
        .navbar {
            background: #2D4059;
            padding: 0.5rem 1.5rem; /* smaller vertical padding to shrink navbar */
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #FFD460; /* 2px yellow border */
            box-sizing: border-box;
        }

        .navbar .brand {
            font-size: 1.5rem;
            color: #FFD460;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .navbar .nav-actions a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            padding: 8px 14px;
            border-radius: 4px;
        }

        /* The gradient lives here now (Blue top, stops at footer) */
        .landing-hero {
            width: 100%;
            max-width: none !important;
            margin: 0 !important;
            border-radius: 0 !important;
            
            /* This forces the blue section to stretch and fill all available space */
            flex: 1; 
            
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            text-align: center;
            padding: 20px;
        }

        /* Ensure footer stays white and sits on top */
        footer {
            background: #2D4059 !important;
            position: relative;
            z-index: 10;
            margin-top: 0 !important;
        }

        /* CTA styles */
        .cta-primary {
            background: #EA5455;
            color: white;
            padding: 12px 26px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.05rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: inline-block;
        }

        .cta-secondary {
            background: transparent;
            color: #2D4059;
            padding: 12px 22px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            border: 1px solid rgba(45,64,89,0.12);
            display: inline-block;
        }
    </style>
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh;">
    
    <nav class="navbar">
        <div class="brand" font-size: 0.9rem; >
            SkillSwap
        </div>
        <div class="nav-actions">
            <a href="/dashboard" class="cta-primary">Log In</a>
        </div>
    </nav>

    <main class="landing-hero">
        <div style="max-width: 800px;">
            <h1 style="font-size: 3.5rem; color: #1e3a8a; margin-bottom: 20px;">Share Skills. Learn Together.</h1>
            <p style="font-size: 1.25rem; color: #4b5563; margin-bottom: 40px; line-height: 1.6;">
                SkillSwap connects students who want to learn together. Whether it's <strong>Calculus</strong>, <strong>Guitar</strong>, or <strong>Python</strong>, find your perfect peer tutor today.
            </p>
            
            <div style="display: flex; gap: 20px; justify-content: center;">
                <a href="/dashboard" class="cta-primary">Get Started</a>
                <a href="/about" class="cta-secondary">Learn More</a>
            </div>
        </div>
    </main>

    <%- include('partials/footer') %>
</body>
</html>


/* ==========================================================================
   FILE: views\my_sessions.ejs
   ========================================================================== */

<!DOCTYPE html>
<html>
<head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css">
    <style>
        /* styles for the dashboard table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f4f4f4; }
        
        /* status color coding */
        .status-requested { color: #d97706; font-weight: bold; } /* amber */
        .status-confirmed { color: #059669; font-weight: bold; } /* green */
        .status-denied, .status-cancelled { color: #dc2626; }    /* red */
        .status-completed { color: #2563eb; }                    /* blue */

        /* action buttons styling */
        .btn-action { padding: 5px 10px; font-size: 0.9em; margin-right: 5px; cursor: pointer; border-radius: 4px; border:none; color: white; background-color: var(--primary-color);}
        .btn-danger { background-color: #ef4444; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <%- include('partials/navbar') %>
    
    <main>
        <div style="margin-bottom: 20px;">
            <a href="/" style="text-decoration: none; color: #333; font-weight: bold;">&larr; Back to Dashboard</a>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="margin: 0;">My Sessions</h1> 
            <a href="/session/request" style="background: #ea5455cc; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px; font-weight: bold;">
                + New Request
            </a>
        </div>

        <p id="loadingMsg">Loading your session history...</p>
        
        <table id="sessionsTable" style="display:none;">
            <thead>
                <tr>
                    <th>Date/Time</th>
                    <th>Role</th>
                    <th>With</th>
                    <th>Topic</th>
                    <th>Status</th>
                    <th>Actions / Link</th>
                </tr>
            </thead>
            <tbody id="sessionsBody">
                </tbody>
        </table>
    </main>
    <%- include('partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // global flag to prevent multiple clicks
        window.isProcessing = false;

        // helper function to show toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            
            // create the toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;

            // add to dom
            container.appendChild(toast);

            // trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // current user id from server session
        const currentUserId = '<%= user.id %>'; 

        // fetch sessions when the page loads
        document.addEventListener('DOMContentLoaded', fetchSessions);

        async function fetchSessions() {
            try {
                // calls the backend api to get the user's session history
                const response = await axios.get(`/api/sessions/user/${currentUserId}`);
                const sessions = response.data.sessions;
                
                const tbody = document.getElementById('sessionsBody');
                tbody.innerHTML = ''; 

                // display empty state if no sessions exist
                if (sessions.length === 0) {
                    document.getElementById('loadingMsg').innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px;">
                            <h3>You haven't scheduled any sessions yet!</h3>
                            <p style="color: #666; margin-bottom: 20px;">Find a tutor or offer your skills to get started.</p>
                            <a href="/session/request" style="background: #ea5455cc; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">Find a Tutor</a>
                            <span style="margin: 0 10px;">or</span>
                            <a href="/profile/edit" style="color: #ea5455cc;">Update Profile</a>
                        </div>
                    `;
                    return;
                }

                // loop through each session to create table rows
                sessions.forEach(session => {
                    const row = document.createElement('tr');
                    
                    // determines if the current user is the teacher or student
                    // converts ids to strings to avoid type mismatches
                    const isTeacher = (String(currentUserId) === String(session.provider_id));
                    const myRole = isTeacher ? 'Teacher' : 'Student';
                    const otherPersonName = isTeacher ? session.requester_name : session.provider_name;

                    // formats the date for display
                    const dateObj = new Date(session.session_date_time);
                    const dateStr = dateObj.toLocaleString(); 

                    let actionsHtml = '';
                    
                    // logic for displaying buttons based on session status
                    if (session.status === 'Requested') {
                        if (isTeacher) {
                            // teacher can confirm or deny
                            actionsHtml = `
                                <button class="btn-action" onclick="confirmSession(${session.session_id}, '${session.location_type}')">Confirm</button>
                                <button class="btn-action btn-danger" onclick="denySession(${session.session_id})">Deny</button>
                            `;
                        } else {
                            // student can cancel
                            actionsHtml = `<button class="btn-action btn-danger" onclick="denySession(${session.session_id})">Cancel Request</button>`;
                        }
                    } 
                    else if (session.status === 'Confirmed') {
                        // show meet link if online
                        if (session.location_type === 'Online' && session.meeting_url) {
                            actionsHtml += `<a href="${session.meeting_url}" target="_blank" style="font-weight:bold;"> Join Meeting</a><br><br>`;
                        } else if (session.location_type === 'In-Person') {
                            actionsHtml += `<span> In-Person</span><br><br>`;
                        }

                        if (isTeacher) {
                            // teacher can mark complete
                            actionsHtml += `<button class="btn-action" onclick="completeSession(${session.session_id})">Mark Complete</button>`;
                        } else {
                            // student just waits
                            actionsHtml += `<span style="font-size:0.8em; color:gray;">Waiting for teacher to complete</span>`;
                        }
                    } 
                    else if (session.status === 'Completed') {
                         if (!isTeacher) {
                             // student view check if already rated
                             if (session.is_rated) {
                                 actionsHtml = '<span style="color:#059669; font-weight:bold;"> Rated</span>';
                             } else {
                                 actionsHtml = `<a href="/session/rate/${session.session_id}" class="btn-action">Rate Teacher</a>`;
                             }
                         } else {
                             // teacher view
                             actionsHtml = '<span> Complete</span>';
                         }
                    }
                    else {
                        // denied or cancelled state
                        actionsHtml = '<span>---</span>';
                    }

                    row.innerHTML = `
                        <td>${dateStr}</td>
                        <td>${myRole}</td>
                        <td>${otherPersonName}</td>
                        <td>${session.skill_name}</td>
                        <td class="status-${session.status.toLowerCase()}">${session.status}</td>
                        <td>${actionsHtml}</td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('loadingMsg').style.display = 'none';
                document.getElementById('sessionsTable').style.display = 'table';

            } catch (error) {
                console.error(error);
                document.getElementById('loadingMsg').textContent = "Error loading session history.";
            }
        }

        // function to confirm a session
        async function confirmSession(id, locationType) {
            // check lock to prevent double clicks
            if (window.isProcessing) return; 
            
            // set lock
            window.isProcessing = true;

            let meetUrl = null;

            // handle url prompt for online sessions
            if (locationType === 'Online') {
                meetUrl = prompt("Please enter the Google Meet URL for this session:");
                
                if (meetUrl === null) {
                    // unlock if cancelled
                    window.isProcessing = false; 
                    return; 
                }
            }

            try {
                await axios.post('/api/sessions/confirm', {
                    sessionId: id,
                    meetingUrl: meetUrl
                });
                
                showToast("Session Confirmed!", "success");
                fetchSessions(); 

            } catch (err) { 
                const msg = err.response?.data?.message || 'Error confirming session';
                showToast(msg, "error"); 
                
            } finally {
                // release lock
                window.isProcessing = false;
            }
        }

        // function to deny or cancel a session
        async function denySession(id) {
            if (window.isProcessing) return;
            window.isProcessing = true;

            if(!confirm("Are you sure you want to cancel/deny this session?")) {
                window.isProcessing = false; // unlock
                return;
            }

            try {
                await axios.post('/api/sessions/deny', { sessionId: id, reason: 'User action' });
                
                showToast("Session cancelled successfully.", "success");
                fetchSessions();
            } catch (err) { 
                const msg = err.response?.data?.message || 'Error processing request';
                showToast(msg, "error");
            } finally {
                window.isProcessing = false;
            }
        }

        // function to mark a session as complete
        async function completeSession(id) {
            if (window.isProcessing) return;
            window.isProcessing = true;

            if(!confirm("Mark this session as fully completed?")) {
                 window.isProcessing = false; // unlock
                 return;
            }
            
            try {
                await axios.post('/api/sessions/complete', { sessionId: id });
                
                showToast("Session marked as complete!", "success");
                fetchSessions();
            } catch (err) { 
                const msg = err.response?.data?.message || 'Error completing session';
                showToast(msg, "error"); 
            } finally {
                window.isProcessing = false;
            }
        }
    </script>
</body>
</html>


/* ==========================================================================
   FILE: views\partials\footer.ejs
   ========================================================================== */

<style>
  /* Footer-specific styles to keep it clean */
  .site-footer {
    background-color: #2d4059;
    border-top: 1px solid var(--border-color);
    padding: 40px 20px;
    margin-top: 60px; /* Push it away from content */
    text-align: center;
    color: white;
    font-size: 0.9em;
  }

  .footer-content {
    max-width: 1000px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
  }

  .footer-section h4 {
    margin-bottom: 5px;
    color: var(--highlight-color);
    font-size: 1.1em;
  }

  .footer-links a {
    margin: 0 10px;
    color: var(--text-muted);
    text-decoration: none;
  }

  .footer-links a:hover {
    color: var(--highlight-color);
  }
</style>

<footer class="site-footer">
  <div class="footer-content">
    <div class="footer-section">
      <h4>SkillSwap: Student Talent Exchange Platform</h4>
      <p>
        <strong>Chapter:</strong> Reno Chapter |
        <strong>School:</strong> Francis Tuttle Institute of Technology
      </p>
      <p>
        <strong>Location:</strong> Oklahoma City, Oklahoma |
        <strong>Year:</strong> 2026
      </p>
      <p>
        <strong>Team Members:</strong> Aaron Kipf, Austin Coco, Michael
        Crawford, Zach All
      </p>
    </div>

    <div class="footer-links">
      <a href="/">Home</a>
      <a href="/about">About Us</a>
      <a href="/session/request">Find a Tutor</a>
      <% if (typeof user !== 'undefined' && user) { %>
      <a href="/profile/edit">My Profile</a>
      <% } else { %>
      <a href="/login">Log In</a>
      <% } %>
    </div>

    <p style="margin-top: 20px; font-size: 0.8em">
      &copy; 2026 SkillSwap. Created for Business Professionals of America
      (V04).
    </p>
  </div>
</footer>


/* ==========================================================================
   FILE: views\partials\navbar.ejs
   ========================================================================== */

<nav class="navbar" style="position: relative; z-index: 1000">
  <a href="/" class="nav-brand">
    <svg
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      style="margin-right: 8px"
    >
      <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
      <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
    </svg>
    SkillSwap
  </a>

  <% if (typeof user !== 'undefined' && user) { %>
  <div class="nav-links">
    <a href="/" class="nav-link">Dashboard</a>
    <a href="/my_sessions" class="nav-link">Sessions</a>
    <a href="/messages" class="nav-link">Messages</a>

    <% if (user.isAdmin) { %>
    <a href="/admin" class="nav-link" style="color: #ce6060">Admin</a>
    <% } %>

    <div style="position: relative; margin-left: 15px">
      <div
        onclick="toggleUserMenu()"
        tabindex="0"
        onkeydown="if(event.key === 'Enter') toggleUserMenu()"
        style="
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 5px;
          border-radius: 6px;
          transition: background 0.2s;
        "
      >
        <span style="font-size: 0.9em; font-weight: bold; color: white"
          ><%= user.name %></span
        >
        <img
          src="https://api.dicebear.com/9.x/<%= user.avatarStyle || 'bottts' %>/svg?seed=<%= user.name %>"
          class="nav-avatar"
          alt="Avatar"
          style="
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #ccc;
          "
        />
        <span style="font-size: 0.8em; color: #ccc"></span>
      </div>

      <div
        id="userDropdown"
        style="
          display: none;
          position: absolute;
          right: 0;
          top: 120%;
          background: white;
          color: #333;
          min-width: 220px;
          border-radius: 8px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
          border: 1px solid #eee;
          overflow: hidden;
        "
      >
        <div
          style="
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            background: #f9fafb;
          "
        >
          <div style="font-weight: bold; font-size: 0.9rem">
            <%= user.name %>
          </div>
        </div>

        <a href="/profile/view/<%= user.id %>" class="menu-item" color="white">
           My Profile
        </a>

        <div
          onclick="toggleColorblind()"
          class="menu-item"
          style="
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <span> High Contrast</span>
          <input type="checkbox" id="cbToggle" style="pointer-events: none" />
        </div>

        <div style="border-top: 1px solid #eee"></div>

        <a
          href="#"
          onclick="handleLogout()"
          class="menu-item"
          style="color: #ef4444"
        >
           Log Out
        </a>
      </div>
    </div>
  </div>

  <% } else { %>
  <div class="nav-links">
    <a href="/login" class="nav-link">Log In</a>
    <a
      href="/register"
      class="nav-link"
      style="
        background-color: var(--primary-color, #2563eb);
        color: white;
        padding: 8px 15px;
        border-radius: 6px;
      "
      >Sign Up</a
    >
  </div>
  <% } %>
</nav>

<style>
  .menu-item {
    display: block;
    padding: 10px 15px;
    text-decoration: none;
    color: #333;
    font-size: 0.9rem;
    transition: background 0.1s;
  }
  .menu-item:hover {
    background: #f3f4f6;
  }

  body.high-contrast-mode {
    filter: contrast(1.5) saturate(0.8);
    background-color: #fff !important;
  }
  body.high-contrast-mode nav,
  body.high-contrast-mode .navbar {
    background: #000 !important;
    border-bottom: 2px solid yellow;
  }
  body.high-contrast-mode a {
    text-decoration: underline;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  function toggleUserMenu() {
    const menu = document.getElementById("userDropdown");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  }

  document.addEventListener("click", function (event) {
    const dropdown = document.getElementById("userDropdown");
    const trigger = event.target.closest('[onclick="toggleUserMenu()"]');
    const insideMenu = event.target.closest("#userDropdown");

    if (!trigger && !insideMenu && dropdown) {
      dropdown.style.display = "none";
    }
  });

  async function handleLogout() {
    if (!confirm("Are you sure you want to log out?")) return;
    try {
      const response = await axios.post("/api/logout");
      if (response.status === 200) window.location.href = "/";
    } catch (error) {
      console.error("Logout Failed:", error);
      alert("Logout failed.");
    }
  }

  function toggleColorblind() {
    const body = document.body;
    const checkbox = document.getElementById("cbToggle");
    body.classList.toggle("high-contrast-mode");

    const isEnabled = body.classList.contains("high-contrast-mode");
    checkbox.checked = isEnabled;
    localStorage.setItem("colorblindMode", isEnabled);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const isEnabled = localStorage.getItem("colorblindMode") === "true";
    if (isEnabled) {
      document.body.classList.add("high-contrast-mode");
      const cb = document.getElementById("cbToggle");
      if (cb) cb.checked = true;
    }
  });
</script>


/* ==========================================================================
   FILE: views\profile_edit.ejs
   ========================================================================== */

<!DOCTYPE html>
<html>
<head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css">
    <style>
        /* ADDED: Hover effect to help users track rows */
        tr:hover {
            background-color: #f3f4f6; /* Light gray highlight on hover */
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    
    <%- include('partials/navbar') %>

    <main>
        <div style="margin-bottom: 20px;">
            <a href="/" style="text-decoration: none; color: #333; font-weight: bold;">
                &larr; Back to Dashboard
            </a>
        </div>
        
        <h1>Edit Profile for <%= user.name %></h1>

        <form id="profileForm">
            <h2>Personal Information</h2>
            
            <label for="avatarStyle">Avatar Style:</label>
            <select id="avatarStyle">
                <option value="bottts" <%= user.avatarStyle === 'bottts' ? 'selected' : '' %>> Robots</option>
                <option value="avataaars" <%= user.avatarStyle === 'avataaars' ? 'selected' : '' %>> Humans</option>
                <option value="identicon" <%= user.avatarStyle === 'identicon' ? 'selected' : '' %>> Shapes</option>
                <option value="initials" <%= user.avatarStyle === 'initials' ? 'selected' : '' %>> Initials</option>
                <option value="micah" <%= user.avatarStyle === 'micah' ? 'selected' : '' %>> Hand Drawn</option>
            </select>

            <label for="userName">Full Name:</label>
            <input type="text" id="userName" value="<%= user.name %>" required>

            <label for="gradeLevel">Grade Level:</label>
            <input type="text" id="gradeLevel" value="<%= user.gradeLevel || '' %>">

            <button type="submit">Update Profile</button>
        </form>

        <hr>

        <form id="skillOfferForm">
            <h2>Skills You Offer</h2>
            <p>Check the skills you want to teach, and select where you can teach them.</p>

            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: center; width: 80px; vertical-align: middle;">Offer?</th>
                            <th style="text-align: left; vertical-align: middle;">Skill Name</th>
                            <th style="text-align: center; vertical-align: middle;">I can teach<br>Virtual</th>
                            <th style="text-align: center; vertical-align: middle;">I can teach<br>In-Person</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% masterSkills.forEach(skill => { %>
                            <tr style="border-bottom: 1px solid #b0b0b0; vertical-align: middle;">
                                <td style="text-align: center; vertical-align: middle;">
                                    <input type="checkbox" 
                                        class="skill-toggle" 
                                        data-id="<%= skill.skill_id %>"
                                        id="skill_<%= skill.skill_id %>"
                                        style="margin: 0; vertical-align: middle;">
                                </td>
                                
                                <td style="vertical-align: middle;">
                                    <label for="skill_<%= skill.skill_id %>" style="cursor: pointer; display: block; width: 100%; margin: 0; line-height: 1.2;"><%= skill.skill_name %></label>
                                </td>

                                <td style="text-align: center; vertical-align: middle;">
                                    <input type="checkbox" class="loc-virtual" data-id="<%= skill.skill_id %>" style="margin: 0; vertical-align: middle;">
                                </td>
                                <td style="text-align: center; vertical-align: middle;">
                                    <input type="checkbox" class="loc-inperson" data-id="<%= skill.skill_id %>" style="margin: 0; vertical-align: middle;">
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
            
            <p style="font-size: 0.9em; color: #666;">
                * If you check both Virtual and In-Person, you will appear in searches for both.
            </p>

            <button type="submit" style="margin-top: 15px;">Save Offered Skills</button>
        </form>

        <hr>

        <form id="skillSeekForm">
            <h2>Skills You Want to Learn</h2>
            <p>Check the skills you want to learn, and select your preferred setting.</p>

            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: center; width: 80px; vertical-align: middle;">Seek?</th>
                            <th style="text-align: left; vertical-align: middle;">Skill Name</th>
                            <th style="text-align: center; vertical-align: middle;">Prefer<br>Virtual</th>
                            <th style="text-align: center; vertical-align: middle;">Prefer<br>In-Person</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% masterSkills.forEach(skill => { %>
                            <tr style="border-bottom: 1px solid #b0b0b0; vertical-align: middle;">
                                <td style="text-align: center; vertical-align: middle;">
                                    <input type="checkbox" 
                                        class="seek-toggle" 
                                        data-id="<%= skill.skill_id %>"
                                        id="seek_skill_<%= skill.skill_id %>"
                                        style="margin: 0; vertical-align: middle;">
                                </td>
                                
                                <td style="vertical-align: middle;">
                                    <label for="seek_skill_<%= skill.skill_id %>" style="cursor: pointer; display: block; width: 100%; margin: 0; line-height: 1.2;"><%= skill.skill_name %></label>
                                </td>

                                <td style="text-align: center; vertical-align: middle;">
                                    <input type="checkbox" 
                                        class="seek-virtual" 
                                        data-id="<%= skill.skill_id %>"
                                        style="margin: 0; vertical-align: middle;">
                                </td>
                                <td style="text-align: center; vertical-align: middle;">
                                    <input type="checkbox" 
                                        class="seek-inperson" 
                                        data-id="<%= skill.skill_id %>"
                                        style="margin: 0; vertical-align: middle;">
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
            
            <button type="submit" style="margin-top: 15px;">Save Sought Skills</button>
        </form>

        <hr>
        
        <h2>Missing a Skill?</h2>
        <form id="suggestSkillForm">
            <input type="text" id="newSkillName" placeholder="e.g., Quantum Physics Tutoring">
            <button type="submit">Suggest Skill</button>
        </form>
        
    </main>
    <%- include('partials/footer') %>
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // --- Client-Side JavaScript Logic ---
        
        const userId = '<%= user.id %>'; // pass the user's id for api submissions

        // helper function to show toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 1. logic for saving skills offered
        document.getElementById('skillOfferForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const skillsToSubmit = [];
            
            // iterate over all the master checkboxes to find selected skills
            const skillCheckboxes = document.querySelectorAll('.skill-toggle');

            skillCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const id = checkbox.getAttribute('data-id');
                    
                    // find the corresponding location checkboxes for this skill id
                    const canDoVirtual = document.querySelector(`.loc-virtual[data-id="${id}"]`).checked;
                    const canDoInPerson = document.querySelector(`.loc-inperson[data-id="${id}"]`).checked;

                    // translation logic converts ui choices to database flags
                    let isVirtualOnly = false;
                    let isInPersonOnly = false;

                    if (canDoVirtual && !canDoInPerson) {
                        isVirtualOnly = true;
                    } else if (!canDoVirtual && canDoInPerson) {
                        isInPersonOnly = true;
                    } 
                    // if both are checked, both flags remain false meaning flexible

                    skillsToSubmit.push({
                        skillId: id,
                        isVirtualOnly: isVirtualOnly,
                        isInPersonOnly: isInPersonOnly
                    });
                }
            });

            try {
                // sends the array of selected skills to the backend
                const response = await axios.post('/api/user/skills/offer', {
                    userId: userId, 
                    skills: skillsToSubmit
                });
                showToast(response.data.message, "success");
            } catch (error) {
                showToast('Failed to save skills. Please try again.', "error");
                console.error(error);
            }
        });

        // 2. logic for saving skills sought
        document.getElementById('skillSeekForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const skillsToSubmit = [];
            
            // iterate over the seek toggle checkboxes
            const skillCheckboxes = document.querySelectorAll('.seek-toggle');

            skillCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const id = checkbox.getAttribute('data-id');
                    
                    const wantVirtual = document.querySelector(`.seek-virtual[data-id="${id}"]`).checked;
                    const wantInPerson = document.querySelector(`.seek-inperson[data-id="${id}"]`).checked;

                    let isVirtualOnly = false;
                    let isInPersonOnly = false;

                    if (wantVirtual && !wantInPerson) {
                        isVirtualOnly = true;
                    } else if (!wantVirtual && wantInPerson) {
                        isInPersonOnly = true;
                    } 

                    skillsToSubmit.push({
                        skillId: id,
                        isVirtualOnly: isVirtualOnly,
                        isInPersonOnly: isInPersonOnly
                    });
                }
            });

            try {
                const response = await axios.post('/api/user/skills/seek', {
                    userId: userId, 
                    skills: skillsToSubmit
                });
                showToast(response.data.message, "success");
            } catch (error) {
                showToast('Failed to save sought skills.', "error");
                console.error(error);
            }
        });
        
        // 3. logic for suggesting a skill
        document.getElementById('suggestSkillForm').addEventListener('submit', async (e) => {
             e.preventDefault();
             const skillName = document.getElementById('newSkillName').value;

             if (!skillName) return;

             try {
                const response = await axios.post('/api/skills/suggest', {
                    skillName: skillName,
                    userId: userId 
                });
                showToast(response.data.message, "success");
                document.getElementById('newSkillName').value = '';
            } catch (error) {
                const msg = error.response?.data?.message || 'Error suggesting skill.';
                showToast(msg, "error");
            }
        });

        // 4. logic for basic profile update
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userName = document.getElementById('userName').value;
            const gradeLevel = document.getElementById('gradeLevel').value;
            const avatarStyle = document.getElementById('avatarStyle').value;

            try {
                const response = await axios.put(`/api/user/profile/${userId}`, {
                    userName: userName,
                    gradeLevel: gradeLevel,
                    avatarStyle: avatarStyle
                });
                showToast(response.data.message, "success");
            } catch (error) {
                const msg = error.response?.data?.message || 'Failed to update profile.';
                showToast(msg, "error");
            }
        });

       // 5. pre-fill skills on page load
       // fetches the users current skills and checks the boxes
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await axios.get(`/api/user/skills/${userId}`);
                const { offered, sought } = response.data;

                const checkBoxes = (skillList, type) => {
                    skillList.forEach(skill => {
                        const id = skill.skill_id;
                        
                        // check the master toggle for this skill
                        const masterBox = document.getElementById(`${type}skill_${id}`);
                        if (masterBox) masterBox.checked = true;

                        const virtualClass = type === 'seek_' ? '.seek-virtual' : '.loc-virtual';
                        const inPersonClass = type === 'seek_' ? '.seek-inperson' : '.loc-inperson';

                        const virtualBox = document.querySelector(`${virtualClass}[data-id="${id}"]`);
                        const inPersonBox = document.querySelector(`${inPersonClass}[data-id="${id}"]`);

                        // determine which location boxes to check based on db flags
                        if (skill.is_virtual_only) {
                            if (virtualBox) virtualBox.checked = true;
                        } else if (skill.is_inperson_only) {
                            if (inPersonBox) inPersonBox.checked = true;
                        } else {
                            // if neither is restricted check both
                            if (virtualBox) virtualBox.checked = true;
                            if (inPersonBox) inPersonBox.checked = true;
                        }
                    });
                };

                if (offered.length > 0) checkBoxes(offered, '');
                if (sought.length > 0) checkBoxes(sought, 'seek_');

            } catch (error) {
                console.error('Failed to load existing skills:', error);
            }
        }); 
    </script>
</body>
</html>

/* ==========================================================================
   FILE: views\profile_view.ejs
   ========================================================================== */

<!DOCTYPE html>
<html>
  <head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css" />
    <style>
      .profile-header {
        background: #fbdddd;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 5px solid #ea5455;
      }
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        margin-right: 5px;
        color: white;
      }
      .badge-virtual {
        background-color: #3b82f6;
      }
      .badge-person {
        background-color: #10b981;
      }
      .badge-both {
        background-color: #ea5455cc;
      }

      .skill-list {
        list-style: none;
        padding: 0;
      }
      .skill-item {
        background: white;
        border: 1px solid #eee;
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
      }

      .rating-box {
        background: #fffbeb;
        border: 5px solid #fcd34d;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 20px;
      }
      .rating-score {
        font-size: 2em;
        font-weight: bold;
        color: #d97706;
      }
    </style>
  </head>
  <body>
    <div id="toast-container"></div>

    <%- include('partials/navbar') %>

    <main>
      <div class="profile-header">
        <div
          style="
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
          "
        >
          <img
            src="https://api.dicebear.com/9.x/<%= profile.avatar_style %>/svg?seed=<%= profile.user_name %>"
            alt="Profile Avatar"
            style="
              width: 80px;
              height: 80px;
              border-radius: 50%;
              background: white;
              padding: 5px;
            "
          />

          <div>
            <h1 style="margin: 0; line-height: 1"><%= profile.user_name %></h1>
            <p style="margin: 5px 0 0 0; color: #666"><%= profile.email %></p>
          </div>
        </div>

        <p>
          <strong>Grade:</strong> <%= profile.grade_level || 'Not specified' %>
          | <strong>School:</strong> <%= profile.school_college || 'Not
          specified' %>
        </p>

        <% if (String(user.id) === String(profile.user_id)) { %>
        <a
          href="/profile/edit"
          style="
            background: #333;
            color: white;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
          "
          >Edit My Profile</a
        >
        <% } else { %>
        <a
          href="/session/request"
          style="
            background: #2563eb;
            color: white;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
          "
          >Request Session</a
        >

        <a
          href="/messages/<%= profile.user_id %>"
          style="
            background: #059669;
            color: white;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            margin-left: 10px;
          "
        >
           Message
        </a>

        <button
          onclick="reportUser('<%= profile.user_id %>')"
          style="
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
          "
        >
           Report User
        </button>
        <% } %>
      </div>

      <div class="rating-box">
        <h3>Community Reputation</h3>
        <% if (ratingStats.count > 0) { %>
        <div class="rating-score"><%= ratingStats.percent %>% Positive</div>
        <p>
          <%= ratingStats.likes %> Likes from <%= ratingStats.count %> Total
          Sessions
        </p>
        <% } else { %>
        <p>
          No ratings yet. Be the first to learn from <%= profile.user_name %>!
        </p>
        <% } %>
      </div>

      <hr />

      <h2>Skills I Teach</h2>
      <% if (skillsOffered.length === 0) { %>
      <p>No skills listed yet.</p>
      <% } else { %>
      <ul class="skill-list">
        <% skillsOffered.forEach(skill => { %>
        <li class="skill-item">
          <strong><%= skill.skill_name %></strong>
          <span>
            <% if (skill.is_virtual_only) { %>
            <span class="badge badge-virtual">Virtual Only</span>
            <% } else if (skill.is_inperson_only) { %>
            <span class="badge badge-person">In-Person Only</span>
            <% } else { %>
            <span class="badge badge-both">Virtual & In-Person</span>
            <% } %>
          </span>
        </li>
        <% }) %>
      </ul>
      <% } %>

      <hr />

      <h2>Skills I Want to Learn</h2>
      <% if (skillsSought.length === 0) { %>
      <p>Not currently seeking any specific skills.</p>
      <% } else { %>
      <ul>
        <% skillsSought.forEach(skill => { %>
        <li><%= skill.skill_name %></li>
        <% }) %>
      </ul>
      <% } %>
    </main>
    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      // creates a temporary toast notification on the screen
      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        // triggers the slide in animation
        requestAnimationFrame(() => toast.classList.add("show"));

        // removes the toast after 3 seconds
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // allows a user to report another user for bad behavior
      async function reportUser(reportedUserId) {
        // asks the user to type a reason for the report
        const reason = prompt("Please describe the issue with this user:");

        // if the user clicks cancel do nothing
        if (!reason) return;

        try {
          // sends the report details to the api
          const response = await axios.post("/api/reports", {
            reportedUserId: reportedUserId,
            reason: reason,
          });

          // shows a success message if it worked
          showToast(response.data.message, "success");
        } catch (error) {
          console.error(error);
          showToast("Failed to submit report. Please try again.", "error");
        }
      }
    </script>
  </body>
</html>


/* ==========================================================================
   FILE: views\rating_form.ejs
   ========================================================================== */

<!DOCTYPE html>
<html>
  <head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css" />
    <style>
      /* specific styles for the rating form container */
      .rating-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
      }

      /* styles for the radio button options to ensure alignment */
      .radio-option {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 1.1em;
        cursor: pointer;
      }
      .radio-option input[type="radio"] {
        margin-right: 10px;
        transform: scale(1.2);
        width: auto;
        display: inline-block;
        margin-bottom: 0;
      }

      /* styling for the feedback text area */
      textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <div id="toast-container"></div>
    <%- include('partials/navbar') %>

    <main>
      <div class="rating-container">
        <h1>Rate Your Session</h1>
        <p>
          How was your session with
          <strong><%= session.provider_name %></strong>?
        </p>

        <form id="ratingForm">
          <input
            type="hidden"
            id="sessionId"
            value="<%= session.session_id %>"
          />
          <input type="hidden" id="raterId" value="<%= user.id %>" />
          <input
            type="hidden"
            id="rateeId"
            value="<%= session.provider_id %>"
          />

          <label><strong>Would you recommend this teacher?</strong></label>
          <div
            style="
              margin: 20px 0;
              padding: 10px;
              background: white;
              border: 1px solid #eee;
            "
          >
            <label class="radio-option">
              <input type="radio" name="likeStatus" value="true" required />
               Yes (Like)
            </label>
            <label class="radio-option">
              <input type="radio" name="likeStatus" value="false" />
               No
            </label>
          </div>

          <label for="feedbackText"
            ><strong>Additional Comments (Optional):</strong></label
          >
          <textarea
            id="feedbackText"
            placeholder="What did you learn? How was the teaching style?"
          ></textarea>

          <button type="submit" style="margin-top: 15px">Submit Rating</button>
        </form>
      </div>
    </main>
    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      // helper function to show toast notifications
      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        // triggers the slide in animation
        requestAnimationFrame(() => toast.classList.add("show"));

        // removes the toast after 3 seconds
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // handles the form submission
      document
        .getElementById("ratingForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // 1. Select the button so we can lock it
          const submitBtn = document.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;

          // capture form values
          const sessionId = document.getElementById("sessionId").value;
          const raterId = document.getElementById("raterId").value;
          const rateeId = document.getElementById("rateeId").value;
          const feedbackText = document.getElementById("feedbackText").value;

          // determine which radio button was selected
          const likeRadio = document.querySelector(
            'input[name="likeStatus"]:checked'
          );
          const likeStatus = likeRadio ? likeRadio.value === "true" : null;

          // ensures a rating is actually selected
          if (likeStatus === null) {
            showToast(
              "Please select whether you recommend this teacher.",
              "error"
            );
            return; // Stop here (don't disable the button yet)
          }

          // 2. LOCK THE BUTTON (Visual Feedback + Prevention)
          submitBtn.disabled = true;
          submitBtn.textContent = "Submitting...";

          try {
            // sends the rating to the backend api
            await axios.post("/api/sessions/rate", {
              sessionId: sessionId,
              raterId: raterId,
              rateeId: rateeId,
              likeStatus: likeStatus,
              feedbackText: feedbackText,
            });

            showToast("Rating submitted! Redirecting...", "success");

            // redirects the user back to their sessions list
            setTimeout(() => {
              window.location.href = "/my_sessions";
            }, 1500);
          } catch (error) {
            // 3. UNLOCK THE BUTTON (If it fails, let them try again)
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;

            const msg =
              error.response?.data?.message || "Error submitting rating.";
            showToast(msg, "error");
          }
        });
    </script>
  </body>
</html>


/* ==========================================================================
   FILE: views\register.ejs
   ========================================================================== */

<!DOCTYPE html>
<html>
<head>
    <title>SkillSwap - Register</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    <div id="toast-container"></div>

    <%- include('partials/navbar') %>

    <main>
        <h1>Create Your SkillSwap Account</h1>
        <p>All fields marked with an asterisk (*) are required.</p>

        <form id="registerForm">
            <label for="email">Email *</label>
            <input type="email" id="regEmail" required>

            <label for="password">Password *</label>
            <input type="password" id="regPassword" required>

            <label for="passwordConfirm">Confirm Password *</label>
            <input type="password" id="passwordConfirm" required>

            <label for="userName">Full Name *</label>
            <input type="text" id="regUserName" required>

            <label for="dateOfBirth">Date of Birth *</label>
            <input type="date" id="regDateOfBirth" required>

            <label for="gradeLevel">Grade/Education Level</label>
            <select id="regGradeLevel">
                <option value="">-- Select --</option>
                <option value="6th">6th Grade</option>
                <option value="7th">7th Grade</option>
                <option value="12th">12th Grade</option>
                <option value="College">College</option>
            </select>

            <label for="schoolCollege">School/College (Optional)</label>
            <input type="text" id="regSchoolCollege">

            <label for="avatarStyle">Choose Avatar Style:</label>
            <select id="regAvatarStyle">
                <option value="bottts"> Robots (Default)</option>
                <option value="avataaars"> Humans</option>
                <option value="identicon"> Geometric Shapes</option>
                <option value="initials"> Initials</option>
                <option value="micah"> Hand Drawn</option>
            </select>

            <button type="submit">Register Account</button>
        </form>
        
        <p id="messageArea" style="margin-top: 15px;"></p>
    </main>

    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // helper function to show toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            // triggers the slide in animation
            requestAnimationFrame(() => toast.classList.add('show'));
            
            // removes the toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // listens for the form submit event
        document.getElementById('registerForm').addEventListener('submit', handleRegisterSubmit);

        // handles the registration logic
        async function handleRegisterSubmit(event) {
            // prevents the default form submission to stop page reload
            event.preventDefault(); 

            // get values from the form inputs
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('passwordConfirm').value;
            const userName = document.getElementById('regUserName').value;
            const dateOfBirth = document.getElementById('regDateOfBirth').value;
            const gradeLevel = document.getElementById('regGradeLevel').value;
            const schoolCollege = document.getElementById('regSchoolCollege').value;
            const avatarStyle = document.getElementById('regAvatarStyle').value;
            const messageArea = document.getElementById('messageArea');
            messageArea.textContent = ''; 

            // client side check to ensure passwords match
            if (password !== passwordConfirm) {
                showToast('Error: Passwords do not match.', 'error');
                return;
            }

            try {
                // sends the registration data to the backend api
                const response = await axios.post('/api/register', {
                    email: email,
                    password: password,
                    userName: userName,
                    dateOfBirth: dateOfBirth,
                    gradeLevel: gradeLevel, 
                    schoolCollege: schoolCollege,
                    avatarStyle: avatarStyle
                });

                // if registration is successful redirect to the login page
                if (response.status === 201) {
                    showToast('Registration successful! Redirecting to login...', 'success');
                    
                    // wait a moment for the toast to show before redirecting
                    setTimeout(() => {
                        window.location.href = '/'; 
                    }, 1500);
                }

            } catch (error) {
                // handle errors like duplicate email
                let errorMessage = 'An unexpected server error occurred.';
                
                if (error.response) {
                    errorMessage = error.response.data.message || errorMessage;
                }
                
                showToast(errorMessage, 'error');
                console.error('Registration Failed:', errorMessage);
            }
        }
    </script>
</body>
</html>

/* ==========================================================================
   FILE: views\reset_password.ejs
   ========================================================================== */

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Password - SkillSwap</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh; background-color: #f9fafb;">

    <%- include('partials/navbar') %>

    <main style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px;">
            <h2 style="margin-top: 0; text-align: center; color: #333;">Create New Password</h2>
            
            <form action="/reset-password/<%= token %>" method="POST" style="margin-top: 20px;">
                <input type="password" name="newPassword" placeholder="New Password" required 
                       style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                
                <button type="submit" style="width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                    Update Password
                </button>
            </form>
        </div>
    </main>

    <%- include('partials/footer') %>
</body>
</html>

/* ==========================================================================
   FILE: views\session_request.ejs
   ========================================================================== */

<!DOCTYPE html>
<html>
  <head>
    <title><%= pageTitle %></title>
    <link rel="stylesheet" href="/styles/main.css" />
  </head>
  <body>
    <div id="toast-container"></div>
    <%- include('partials/navbar') %>

    <main>
      <div style="margin-bottom: 20px">
        <a
          href="/"
          style="text-decoration: none; color: #333; font-weight: bold"
          >&larr; Back to Dashboard</a
        >
      </div>

      <h1>Request a Tutoring Session</h1>
      <p>
        First, choose a topic. Then, select a tutor available for that skill.
      </p>

      <form id="sessionRequestForm">
        <label for="skillTaughtId">I want to learn:</label>
        <select id="skillTaughtId" required onchange="loadProviders()">
          <option value="">-- Select a Topic --</option>
          <% skills.forEach(skill => { %>
          <option value="<%= skill.skill_id %>"><%= skill.skill_name %></option>
          <% }) %>
        </select>

        <label for="providerId">Select a Tutor:</label>
        <select id="providerId" required disabled>
          <option value="">-- Please select a topic first --</option>
        </select>

        <label for="sessionDateTime">Proposed Date & Time:</label>
        <input type="datetime-local" id="sessionDateTime" required />
        <p style="font-size: 0.8em; color: #666">
          * The tutor will confirm the exact time with you.
        </p>

        <label for="locationType">Preferred Location:</label>
        <select id="locationType" required>
          <option value="">-- Select --</option>
          <option value="Online">Online (Virtual)</option>
          <option value="In-Person">In-Person</option>
        </select>

        <button type="submit">Send Request</button>
      </form>

      <p id="messageArea" style="margin-top: 15px"></p>
    </main>
    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const requesterId = "<%= user.id %>";
      // flag to prevent double submission
      window.isProcessing = false;

      // helper function to show toast notifications
      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add("show"));
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // loads the list of tutors who teach the selected skill
      async function loadProviders() {
        const skillId = document.getElementById("skillTaughtId").value;
        const providerSelect = document.getElementById("providerId");

        // reset provider dropdown
        providerSelect.innerHTML =
          '<option value="">-- Loading Tutors... --</option>';
        providerSelect.disabled = true;

        if (!skillId) {
          providerSelect.innerHTML =
            '<option value="">-- Please select a topic first --</option>';
          return;
        }

        try {
          // fetch specific providers for this skill from the api
          const response = await axios.get(`/api/skills/${skillId}/providers`);
          const providers = response.data.providers;

          providerSelect.innerHTML =
            '<option value="">-- Select a Tutor --</option>';

          if (providers.length === 0) {
            providerSelect.innerHTML +=
              '<option value="" disabled>No tutors found for this skill</option>';
            showToast("No tutors currently offer this skill.", "info");
          } else {
            // populate the dropdown with available tutors
            providers.forEach((p) => {
              providerSelect.innerHTML += `<option value="${p.user_id}">${p.user_name}</option>`;
            });
            providerSelect.disabled = false;
          }
        } catch (error) {
          console.error(error);
          providerSelect.innerHTML =
            '<option value="">Error loading tutors</option>';
          showToast("Failed to load tutors list.", "error");
        }
      }

      // handles form submission with locking and toasts
      document
        .getElementById("sessionRequestForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // checks lock to prevent double clicks
          if (window.isProcessing) return;

          const submitBtn = document.querySelector('button[type="submit"]');
          const originalBtnText = submitBtn.textContent;

          const providerId = document.getElementById("providerId").value;
          const skillTaughtId = document.getElementById("skillTaughtId").value;
          const rawDateValue = document.getElementById("sessionDateTime").value;
          const locationType = document.getElementById("locationType").value;

          if (!providerId || !skillTaughtId || !rawDateValue) {
            showToast("Please fill out all fields.", "error");
            return;
          }

          // sets lock and updates button text
          window.isProcessing = true;
          submitBtn.disabled = true;
          submitBtn.textContent = "Sending...";

          // converts local time to utc for storage
          const localDate = new Date(rawDateValue);
          const sessionDateTime = localDate.toISOString();

          try {
            // sends the session request to the api
            const response = await axios.post("/api/sessions/request", {
              requesterId: requesterId,
              providerId: providerId,
              skillTaughtId: skillTaughtId,
              sessionDateTime: sessionDateTime,
              locationType: locationType,
            });

            showToast("Request sent successfully!", "success");

            // redirects to the session list after a short delay
            setTimeout(() => {
              window.location.href = "/my_sessions";
            }, 1500);
          } catch (error) {
            const msg =
              error.response?.data?.message || "Error submitting request.";
            showToast(msg, "error");

            // resets button only on error
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
          } finally {
            // releases lock
            window.isProcessing = false;
          }
        });

      // PREVENT PAST DATES
      const dateInput = document.getElementById("sessionDateTime");
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Adjust for local time
      dateInput.min = now.toISOString().slice(0, 16); // Set minimum to "Right Now"
    </script>
  </body>
</html>
